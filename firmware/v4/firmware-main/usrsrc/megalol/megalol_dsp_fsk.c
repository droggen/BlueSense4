#include <stdio.h>
#include <malloc.h>
#include <string.h>
#include "stm32l496xx.h"
#include "megalol_dsp.h"
#include "megalol_dsp_r2iq.h"
#include "stmcic.h"
#include "global.h"
#include "dfsdm.h"
#include "megalol_comm_softuart.h"
#include "main.h"
#include "helper.h"
#include "ufat.h"
#include "wait.h"
#include "stmdac.h"
#include "megalol_dsp_fsk.h"
#include "stmadcfast.h"
#include "serial_usart3.h"
#include "stm32l4xx_hal.h"


#define DSP_FSK_USE_CIC_16BIT	1

// Allocate both 32-bit or 16-bit CIC result as tests/benchmarks use both
int _fsk_di[CICBUFSIZ/2+1],_fsk_dq[CICBUFSIZ/2+1];			// +1 to hold the previous sample value to ensure streaming implementation of crossproduct
short _fsk_dis[CICBUFSIZ/2+2],_fsk_dqs[CICBUFSIZ/2+2];		// +2: +1 to hold the previous sample value to ensure streaming implementation of crossproduct, and +1 for SIMD implementation reading 32-bit at a time.
short _fsk_tmp_di[CICBUFSIZ],_fsk_tmp_dq[CICBUFSIZ];		// Test variables: write two I, Q lanes prior to CIC filtering. Lanes have 0 I 0 -I ..., Q 0 -Q 0...
int _fsk_cp[CICBUFSIZ/2];									// Result of cross-product
int _fsk_cp2[CICBUFSIZ/2];
int _fsk_cp3[CICBUFSIZ/2];
unsigned char _fsk_binary[CICBUFSIZ/2+4];						// Binary outcome of demodulation, and input to decoding. Extra space for SIMD processing.
unsigned char _fsk_binary2[CICBUFSIZ/2+4];						// Binary outcome of demodulation, and input to decoding
unsigned char _fsk_binary3[CICBUFSIZ/2+4];						// Binary outcome of demodulation, and input to decoding
int _fsk_downsampling=2;

// Spectrum generated from Matlab with an asymetrial shape
short testsignal_recognizablespectrum[FSKTESTSIGNALLEN]={4095,1704,1378,2239,1989,1899,2250,1764,2233,1845,1866,1945,1792,1969,1768,1873,1985,1848,1883,1872,1846,1930,1747,1937,1912,1872,1937,1861,1999,1890,1856,1915,1911,1924,1868,1866,2004,1881,1880,1889,1883,1923,1797,1911,1915,1869,1880,1887,1948,1890,1808,1922,1927,1904,1872,1872,2004,1882,1864,1906,1927,1908,1823,1904,1951,1868,1881,1890,1916,1907,1814,1905,1904,1905,1869,1868,1978,1897,1854,1897,1913,1917,1862,1892,1965,1872,1891,1899,1918,1906,1822,1902,1913,1897,1872,1866,1957,1905,1820,1907,1917,1904,1845,1893,1986,1868,1882,1906,1918,1908,1836,1904,1938,1889,1891,1868,1948,1908,1804,1912,1907,1903,1847,1881,1986,1871,1863,1916,1901,1910,1827,1907,1977,1865,1899,1880,1956,1917,1790,1914,1905,1905,1888,1855,1981,1880,1844,1925,1851,1921,1826,1882,2000,1853,1948,1874,1912,1961,1736,1930,1915,1870,1994,1793,2076,1901,1742,2040,1587,1997,1828,1526,3214,1948,258,2276,2374,1672,2221,1767,1920,1963,1639,1982,1884,1875,1958,1835,2048,1862,1820,1949,1829,1923,1813,1889,2011,1850,1889,1885,1913,1934,1781,1917,1954,1876,1907,1876,1986,1880,1826,1933,1887,1903,1865,1875,1970,1882,1868,1889,1898,1929,1800,1896,1958,1878,1883,1885,1962,1892,1825,1927,1917,1892,1887,1881,1970,1886,1862,1896,1900,1922,1816,1882,1953,1891,1876,1877,1921,1912,1827,1914,1919,1883,1893,1882,1969,1892,1863,1901,1911,1920,1845,1881,1973,1882,1856,1894,1922,1901,1798,1921,1924,1877,1883,1888,1962,1888,1833,1919,1930,1905,1859,1876,1998,1886,1868,1897,1924,1910,1803,1913,1938,1868,1877,1887,1923,1898,1812,1914,1894,1908,1880,1860,2007,1892,1877,1898,1916,1932,1845,1888,1970,1865,1913,1886,1910,1914,1765,1926,1860,1896,1879,1843,1991,1887,1823,1927,1876,1938,1854,1883,2116,1819,2036,1897,1929,1983,1672,1960,1829,1784,2058,1646,2155,2268,4,1976,3082,1510,1667,2005,1516,2034,1641,1913,1983,1794,1908,1866,1851,1925,1705,1949,1933,1882,1956,1841,2055,1897,1860,1920,1891,1928,1867,1879,1986,1856,1878,1904,1879,1911,1765,1921,1930,1876,1876,1867,1968,1901,1817,1919,1929,1901,1874,1885,2004,1868,1882,1910,1902,1913,1826,1896,1933,1887,1875,1871,1930,1913,1797,1910,1922,1893,1864,1888,1987,1872,1864,1917,1915,1900,1846,1899,1976,1873,1870,1887,1937,1916,1800,1902,1926,1891,1856,1884,1966,1881,1834,1921,1906,1900,1865,1890,1971,1882,1892,1885,1926,1922,1816,1901,1947,1888,1867,1880,1957,1892,1812,1924,1895,1895,1863,1883,1969,1882,1881,1893,1912,1928,1827,1892,1971,1886,1901,1868,1941,1912,1813,1921,1888,1892,1877,1878,1974,1883,1855,1909,1873,1936,1821,1877,1998,1870,1923,1868,1932,1938,1781,1930,1900,1877,1943,1847,2016,1877,1803,1955,1768,1967,1815,1833,2146,1772,2050,1925,1714,2243,957,1608,3654,1670,989,2242,1687,1906,2062,1767,2135,1842,1812,1944,1777,1971,1790,1877,2029,1847,1937,1869,1899,1931,1783,1937,1925,1870,1935,1861,1983,1898,1829,1916,1877,1925,1839,1870,1993,1872,1860,1901,1907,1910,1800,1919,1946,1869,1909,1880,1953,1900,1837,1911,1911,1913,1869,1865,1988,1888,1844,1904,1908,1908,1809,1907,1947,1868,1885,1894,1937,1895,1815,1921,1939,1892,1874,1875,1990,1894,1852,1898,1907,1919,1845,1891,1947,1876,1876,1898,1907,1909,1818,1904,1917,1897,1883,1867,1974,1903,1838,1907,1932,1904,1854,1894,1987,1867,1874,1907,1904,1908,1816,1906,1919,1888,1878,1867,1943,1915,1809,1908,1921,1903,1866,1882,2008,1870,1883,1915,1913,1910,1831,1910,1966,1863,1877,1883,1930,1913,1761,1917,1889,1896,1862,1868,2007,1878,1855,1934,1895,1922,1866,1884,2037,1851,1976,1872,1920,1958,1710,1933,1862,1866,1896,1805,1991,1882,1631,2045,1510,1992,1700,1528,3040,1894,29,2208,2134,1674,2055,1791,1854,1985,1661,1977,1929,1892,2043,1823,2100,1868,1871,1947,1857,1933,1844,1880,1983,1862,1875,1877,1871,1933,1746,1918,1928,1877,1893,1875,1987,1888,1840,1931,1910,1903,1891,1877,1993,1881,1883,1889,1901,1928,1796,1898,1944,1878,1862,1886,1941,1889,1809,1927,1908,1891,1887,1878,1979,1890,1878,1895,1919,1924,1833,1885,1967,1889,1878,1876,1919,1913,1815,1912,1903,1885,1876,1883,1954,1890,1855,1901,1911,1919,1852,1883,1988,1881,1874,1892,1939,1906,1810,1915,1928,1876,1879,1884,1940,1896,1832,1907,1895,1915,1856,1873,1986,1885,1867,1898,1933,1909,1819,1915,1958,1868,1897,1887,1943,1896,1806,1926,1903,1894,1851,1871,1991,1887,1849,1899,1896,1933,1828,1888,1973,1868,1926,1884,1934,1907,1790,1940,1911,1882,1892,1859,2014,1879,1811,1926,1835,1949,1816,1857,2036,1832,1979,1889,1868,1982,1653,1977,1908,1778,2214,1662,2368,2236,250,2014,3249,1502,1804,1981,1586,2049,1736,1907,2069,1798,2004,1869,1903,1949,1748,1936,1909,1890,1936,1838,2020,1889,1808,1932,1871,1915,1829,1892,1991,1851,1888,1899,1891,1920,1808,1909,1940,1888,1909,1860,1979,1909,1817,1916,1917,1900,1854,1887,1981,1867,1863,1910,1888,1913,1822,1897,1940,1887,1889,1871,1949,1911,1817,1905,1927,1907,1887,1873,1972,1889,1866,1911,1898,1907,1838,1890,1943,1886,1874,1878,1924,1919,1804,1901,1932,1901,1887,1870,1967,1894,1862,1913,1910,1900,1860,1901,1975,1867,1862,1898,1921,1916,1793,1896,1931,1895,1874,1868,1947,1906,1839,1914,1906,1898,1882,1891,1996,1867,1875,1910,1926,1915,1807,1899,1954,1881,1866,1880,1935,1905,1780,1929,1891,1887,1881,1875,1992,1881,1885,1909,1906,1936,1848,1879,2016,1867,1917,1878,1927,1923,1729,1945,1862,1870,1882,1847,1975,1872,1788,1962,1782,1964,1860,1819,2244,1781,2238,1917,2016,2237,1347,1640,4093,1638,1353,2247,2000,1908,2250,1781,2245,1823,1846,1959,1801,1967,1769,1884,1988,1850,1880,1873,1851,1941,1748,1929,1907,1872,1936,1862,2001,1896,1858,1916,1910,1925,1872,1872,2009,1879,1875,1887,1885,1926,1797,1910,1915,1872,1884,1886,1944,1894,1813,1924,1925,1900,1869,1873,2005,1890,1872,1893,1914,1923,1836,1895,1943,1875,1882,1891,1915,1904,1814,1908,1904,1904,1871,1869,1979,1890,1845,1905,1930,1907,1843,1898,1978,1868,1888,1898,1919,1907,1822,1905,1912,1897,1873,1868,1955,1901,1819,1908,1917,1903,1845,1895,1987,1865,1883,1906,1919,1910,1835,1901,1937,1889,1891,1867,1949,1912,1805,1907,1901,1913,1858,1868,1971,1883,1873,1906,1896,1911,1837,1902,1963,1876,1917,1869,1944,1919,1794,1911,1910,1896,1871,1864,2000,1874,1832,1933,1857,1922,1823,1892,2007,1838,1932,1888,1923,1943,1727,1942,1923,1872,1993,1793,2075,1893,1733,2032,1583,1985,1816,1492,3236,2028,255,2232,2369,1651,2211,1789,1931,1976,1641,1988,1889,1880,1960,1837,2048,1856,1815,1947,1823,1933,1831,1882,1995,1860,1905,1879,1908,1939,1780,1911,1953,1876,1906,1874,1987,1885,1827,1932,1886,1903,1866,1879,1970,1880,1867,1889,1896,1927,1801,1900,1959,1877,1882,1886,1963,1897,1826,1924,1917,1891,1883,1887,1981,1874,1849,1911,1912,1913,1810,1889,1957,1888,1872,1876,1923,1913,1826,1910,1918,1887,1893,1889,1978,1875,1850,1916,1925,1907,1834,1882,1974,1885,1857,1892,1923,1905,1798,1917,1924,1876,1883,1886,1957,1884,1836,1923,1928,1899,1860,1884,2000,1883,1871,1889,1913,1927,1816,1892,1924,1880,1883,1884,1925,1902,1813,1914,1893,1908,1880,1863,2005,1888,1872,1904,1928,1919,1829,1906,1988,1856,1903,1889,1909,1910,1765,1923,1858,1894,1877,1842,1992,1896,1826,1929,1876,1940,1851,1874,2115,1817,2032,1894,1926,1981,1675,1974,1840,1802,2064,1653,2134,2233,18,2065,3062,1536,1689,1992,1504,2039,1648,1884,1971,1799,1915,1867,1842,1946,1724,1939,1915,1891,1966,1839,2054,1890,1853,1920,1895,1933,1868,1880,1987,1860,1882,1900,1870,1924,1781,1904,1912,1889,1887,1861,1967,1908,1821,1909,1918,1915,1887,1872,1991,1877,1887,1908,1903,1905,1818,1914,1948,1869,1862,1885,1939,1904,1797,1907,1922,1896,1863,1884,1987,1876,1865,1916,1914,1906,1856,1893,1959,1885,1887,1878,1925,1918,1801,1904,1926,1890,1856,1885,1966,1878,1835,1922,1906,1901,1864,1887,1971,1884,1893,1885,1926,1924,1816,1896,1946,1888,1867,1881,1957,1889,1810,1926,1897,1894,1863,1891,1977,1865,1867,1910,1924,1911,1817,1893,1974,1885,1896,1867,1947,1919,1811,1914,1887,1895,1879,1875,1974,1878,1854,1909,1871,1935,1824,1882,1998,1867,1916,1876,1944,1921,1764,1947,1912,1866,1936,1845,2019,1879,1798,1971,1781,1946,1797,1834,2152,1773,2057,1906,1695,2246,995,1656,3640,1621,973,2245,1696,1920,2071,1772,2132,1832,1817,1948,1777,1969,1787,1871,2036,1840,1923,1886,1918,1924,1771,1939,1926,1871,1936,1862,1981,1893,1828,1917,1877,1926,1842,1874,1993,1870,1859,1900,1908,1914,1799,1915,1945,1869,1909,1881,1954,1904,1838,1909,1910,1912,1868,1868,1986,1888,1850,1893,1896,1924,1824,1894,1938,1876,1888,1891,1928,1901,1831,1906,1921,1904,1886,1866,1987,1897,1846,1905,1922,1907,1828,1900,1960,1867,1869,1899,1907,1905,1818,1906,1917,1896,1885,1868,1972,1899,1838,1904,1925,1918,1866,1873,1973,1884,1884,1898,1902,1907,1810,1914,1929,1872,1865,1884,1952,1901,1805,1909,1921,1903,1867,1884,2009,1867,1880,1916,1914,1911,1837,1895,1950,1876,1895,1869,1917,1925,1767,1912,1888,1898,1861,1865,2008,1872,1851,1933,1896,1921,1868,1890,2039,1850,1975,1872,1916,1956,1713,1941,1857,1873,1894,1802,1995,1900,1637,2056,1508,1990,1687,1511,3062,1996,33,2259,2130,1651,2039,1785,1848,1967,1655,1981,1937,1897,2043,1821,2099,1867,1875,1944,1857,1922,1833,1886,1994,1846,1863,1892,1881,1931,1745,1910,1920,1890,1904,1857,1972,1898,1848,1924,1908,1903,1892,1881,1993,1878,1883,1890,1902,1927,1796,1892,1940,1889,1872,1868,1929,1912,1821,1914,1902,1893,1886,1881,1979,1886,1878,1896,1916,1923,1836,1889,1971,1881,1866,1890,1934,1896,1800,1925,1910,1883,1875,1882,1955,1893,1856,1902,1910,1920,1852,1878,1987,1885,1875,1892,1939,1904,1809,1919,1931,1876,1878,1886,1940,1892,1831,1908,1894,1914,1856,1869,1986,1889,1869,1889,1925,1927,1831,1893,1946,1882,1904,1882,1940,1900,1817,1915,1888,1908,1867,1864,1982,1886,1846,1900,1899,1931,1826,1889,1974,1873,1927,1881,1933,1914,1795,1935,1904,1877,1894,1859,2015,1882,1811,1928,1842,1940,1805,1877,2055,1816,1962,1891,1868,1977,1658,1985,1914,1788,2216,1670,2386,2292,239,1925,3237,1531,1807,2009,1606,2030,1716,1903,2072,1794,2000,1865,1898,1943,1748,1941,1911,1892,1939,1840,2017,1885,1806,1932,1871,1916,1827,1886,1991,1854,1889,1902,1892,1923,1808,1906,1938,1888,1910,1861,1976,1906,1817,1917,1918,1901,1855,1890,1983,1864,1860,1911,1888,1905,1814,1908,1951,1871,1877,1885,1958,1909,1815,1905,1931,1908,1882,1868,1975,1890,1865,1908,1896,1905,1839,1895,1943,1884,1875,1878,1921,1916,1806,1905,1935,1902,1882,1866,1971,1901,1861,1908,1908,1903,1863,1889,1962,1882,1878,1885,1906,1923,1801,1898,1934,1892,1870,1868,1949,1905,1836,1910,1906,1901,1885,1882,1986,1882,1891,1894,1911,1928,1816,1888,1952,1882,1866,1878,1937,1902,1780,1930,1894,1886,1881,1877,1992,1876,1883,1909,1904,1935,1851,1885,2014,1868,1918,1875,1929,1928,1728,1938,1860,1867,1880,1847,1977,1882,1792,1958,1782,1963,1866,1825,2244,1776,2230,1901,2000,2242,1382,1688,4083,1590,1381,2245,1988,1895,2252,1765,2232,1845,1866,1945,1790,1969,1769,1874,1992,1839,1868,1884,1864,1922,1734,1941,1914,1871,1936,1869,2006,1875,1845,1935,1921,1911,1862,1871,2012,1875,1865,1899,1901,1913,1782,1916,1922,1869,1885,1883,1941,1890,1816,1928,1924,1895,1871,1880,2007,1884,1864,1905,1928,1907,1821,1913,1953,1868,1879,1891,1916,1906,1814,1907,1903,1904,1871,1867,1979,1896,1846,1905,1930,1906,1843,1901,1980,1867,1886,1900,1919,1905,1822,1908,1913,1896,1873,1866,1955,1906,1821,1906,1917,1906,1844,1891,1987,1868,1884,1907,1920,1907,1832,1915,1948,1871,1880,1886,1957,1897,1800,1912,1905,1911,1855,1869,1975,1890,1872,1903,1895,1917,1835,1905,1969,1861,1906,1887,1956,1909,1787,1920,1912,1898,1873,1866,2000,1870,1828,1932,1859,1921,1825,1892,2000,1848,1949,1876,1910,1962,1737,1928,1917,1864,1986,1793,2084,1909,1735,2032,1581,2002,1836,1517,3210,1964,257,2266,2377,1670,2221,1769,1916,1966,1640,1993,1885,1875,1957,1833,2049,1864,1818,1949,1823,1930,1829,1877,1993,1862,1907,1878,1905,1936,1782,1915,1954,1877,1906,1875,1987,1881,1824,1933,1888,1903,1865,1875,1970,1882,1868,1890,1897,1930,1801,1895,1956,1888,1890,1868,1954,1912,1836,1912,1912,1896,1887,1882,1970,1885,1863,1897,1898,1923,1818,1890,1958,1888,1867,1875,1929,1920,1823,1904,1918,1892,1895,1883,1970,1891,1865,1902,1909,1920,1847,1880,1972,1884,1856,1893,1922,1903,1797,1920,1926,1875,1882,1886,1953,1890,1842,1923,1924,1897,1861,1884,2001,1883,1868,1896,1925,1912,1801,1912,1940,1868,1875,1887,1924,1898,1812,1916,1893,1908,1882,1864,2005,1884,1873,1903,1929,1922,1827,1898,1987,1856,1903,1889,1911,1913,1765,1926,1856,1895,1880,1843,1989,1889,1824,1926,1875,1939,1854,1880,2117,1816,2034,1892,1930,1983,1672,1963,1837,1764,2050,1664,2161,2260,0,1960,3045,1518,1697,1990,1506,2051,1653,1893,1976,1803,1914,1861,1837,1938,1723,1942,1917,1891,1965,1838,2056,1895,1849,1929,1908,1915,1851,1887,1998,1852,1879,1901,1871,1921,1782,1908,1912,1888,1889,1861,1964,1903,1817,1912,1923,1915,1884,1872,1994,1884,1888,1903,1901,1912,1826,1896,1933,1886,1876,1871,1931,1915,1798,1909,1922,1895,1863,1886,1988,1873,1863,1917,1915,1905,1857,1897,1960,1884,1887,1877,1925,1921,1801,1900,1926,1892,1856,1882,1967,1883,1836,1921,1906,1900,1865,1890,1971,1881,1893,1886,1925,1922,1818,1899,1947,1891,1872,1869,1948,1912,1822,1907,1888,1905,1865,1884,1969,1881,1881,1895,1910,1928,1826,1890,1972,1882,1890,1878,1958,1900,1796,1931,1900,1887,1875,1878,1974,1874,1855,1910,1872,1936,1822,1876,1997,1869,1917,1876,1946,1927,1764,1941,1909,1868,1937,1847,2017,1875,1798,1970,1778,1946,1806,1849,2154,1764,2046,1895,1712,2247,961,1591,3656,1687,982,2240,1690,1900,2064,1767,2134,1843,1822,1945,1775,1971,1792,1878,2038,1838,1921,1883,1916,1920,1770,1943,1930,1872,1935,1862,1982,1898,1830,1916,1876,1925,1841,1868,1992,1874,1860,1900,1909,1912,1799,1918,1948,1868,1908,1882,1957,1889,1829,1929,1921,1894,1861,1884,1991,1881,1847,1894,1901,1926,1819,1887,1939,1882,1889,1887,1930,1898,1826,1923,1930,1885,1877,1884,1992,1888,1845,1901,1916,1921,1838,1884,1951,1883,1877,1891,1906,1906,1814,1917,1925,1878,1875,1884,1980,1894,1836,1906,1931,1906,1852,1892,1989,1868,1872,1907,1905,1907,1816,1907,1918,1887,1879,1869,1941,1907,1811,1907,1921,1905,1866,1880,2009,1871,1881,1916,1914,1911,1835,1901,1948,1876,1895,1870,1914,1922,1768,1915,1889,1898,1862,1866,2007,1866,1853,1931,1896,1921,1865,1884,2038,1849,1976,1874,1918,1958,1712,1931,1853,1866,1893,1794,1982,1903,1639,2027,1502,2006,1708,1520,3035,1915,27,2277,2137,1661,2056,1795,1850,1988,1655,1980,1939,1893,2035,1816,2104,1878,1877,1939,1855,1929,1840,1892,1992,1843,1865,1896,1877,1923,1744,1917,1925,1887,1900,1856,1978,1908,1847,1919,1907,1905,1890,1877,1993,1880,1885,1890,1902,1928,1795,1896,1944,1880,1861,1884,1942,1891,1807,1927,1910,1890,1886,1883,1979,1883,1879,1896,1917,1925,1835,1883,1970,1883,1866,1888,1935,1900,1800,1921,1909,1882,1875,1884,1954,1889,1855,1902,1909,1919,1854,1881,1986,1883,1874,1893,1939,1908,1809,1914,1930,1876,1878,1885,1940,1889,1827,1923,1902,1896,1846,1888,1992,1879,1866,1892,1928,1925,1827,1894,1950,1886,1903,1878,1937,1896,1818,1914,1887,1907,1866,1861,1982,1891,1847,1903,1903,1932,1820,1883,1977,1876,1925,1875,1930,1915,1797,1937,1903,1878,1900,1865,2011,1871,1808,1932,1842,1941,1802,1868,2054,1820,1965,1898,1872,1984,1658,1967,1897,1788,2227,1650,2348,2258,260,1993,3256,1502,1788,1997,1602,2033,1722,1915,2079,1793,2002,1872,1902,1949,1748,1936,1908,1889,1938,1837,2018,1892,1808,1930,1870,1916,1825,1890,1993,1851,1886,1901,1891,1919,1809,1910,1939,1888,1911,1862,1977,1902,1818,1911,1913,1915,1862,1866,1974,1885,1868,1901,1886,1912,1821,1898,1937,1886,1891,1871,1947,1913,1817,1909,1938,1895,1872,1888,1988,1872,1855,1918,1900,1905,1838,1899,1948,1868,1867,1898,1930,1905,1801,1908,1937,1898,1877,1868,1974,1901,1857,1904,1909,1908,1866,1892,1963,1881,1878,1886,1907,1921,1801,1893,1934,1890,1863,1879,1963,1893,1824,1925,1915,1894,1882,1885,1986,1879,1890,1895,1909,1927,1819,1892,1952,1882,1867,1878,1935,1898,1779,1932,1893,1887,1880,1875,1993,1881,1885,1910,1905,1935,1850,1878,2013,1868,1918,1876,1926,1925,1728,1943,1864,1870,1881,1848,1975,1872,1784,1965,1788,1944,1853,1836,2251,1771,2234,1921,2012,2250,1357,1605,4087,1674,1399,2231,1979,1912,2259,1777,2235,1822,1852,1966,1798,1957,1769,1890,1995,1839,1866,1882,1866,1929,1734,1937,1913,1871,1936,1866,2003,1882,1852,1936,1917,1907,1862,1881,2014,1873,1864,1899,1901,1911,1781,1920,1925,1868,1884,1882,1935,1897,1828,1910,1910,1913,1881,1866,2003,1889,1865,1902,1928,1909,1821,1907,1953,1867,1878,1892,1915,1903,1814,1909,1903,1903,1873,1869,1977,1892,1846,1906,1930,1909,1842,1896,1980,1868,1886,1899,1920,1906,1822,1906,1912,1896,1873,1868,1953,1903,1821,1906,1915,1915,1851,1875,1979,1886,1890,1892,1916,1910,1835,1902,1936,1887,1892,1867,1947,1913,1806,1907,1906,1909,1849,1866,1980,1890,1868,1898,1895,1920,1838,1903,1963,1875,1917,1870,1942,1920,1796,1916,1910,1898,1874,1850,1994,1895,1838,1914,1852,1934,1827,1885,1999,1849,1951,1874,1912,1957,1740,1934,1921,1869,1986,1803,2088,1881,1716,2047,1596,2003,1815,1550,3227,2055,265,2207,2358,1664,2224,1782,1923,1979,1642,1984,1881,1881,1954,1836,2049,1858,1813,1948,1824,1930,1831,1883,1994,1859,1907,1876,1906,1933,1782,1909,1953,1878,1906,1872,1989,1887,1825,1932,1888,1902,1863,1886,1974,1863,1859,1910,1903,1911,1797,1905,1959,1884,1886,1869,1956,1910,1833,1910,1912,1900,1888,1880,1970,1887,1864,1897,1898,1924,1818,1885,1957,1883,1862,1888,1938,1899,1810,1922,1929,1882,1892,1885,1970,1879,1858,1921,1918,1899,1838,1890,1976,1881,1857,1890,1923,1907,1797,1916,1926,1876,1882,1886,1953,1893,1849,1909,1912,1914,1874,1873,1993,1886,1868,1896,1924,1911,1801,1916,1939,1869,1875,1887,1926,1902,1813,1916,1892,1908,1881,1862,2005,1890,1875,1903,1928,1922,1829,1903,1990,1857,1901,1889,1910,1910,1764,1930,1858,1895,1879,1843,1990,1898,1827,1929,1875,1946,1855,1857,2109,1838,2044,1877,1928,1991,1677,1972,1842,1795,2066,1653,2128,2242,23,2042,3067,1501,1676,2001,1519,2022,1635,1893,1982,1794,1913,1870,1842,1947,1724,1940,1914,1890,1964,1838,2052,1889,1847,1924,1904,1933,1860,1873,1992,1869,1883,1893,1869,1918,1781,1905,1911,1888,1889,1861,1965,1910,1819,1915,1929,1902,1872,1886,2005,1866,1878,1912,1903,1911,1827,1901,1933,1885,1877,1871,1929,1911,1798,1910,1922,1898,1863,1883,1989,1878,1863,1917,1915,1905,1856,1893,1959,1884,1888,1878,1923,1919,1803,1902,1926,1892,1856,1883,1967,1879,1833,1922,1907,1898,1863,1889,1973,1871,1887,1905,1933,1905,1812,1907,1948,1887,1869,1869,1953,1909,1818,1905,1890,1908,1866,1883,1970,1869,1875,1912,1917,1905,1821,1910,1975,1875,1890,1870,1955,1921,1803,1908,1892,1904,1879,1867,1973,1877,1857,1911,1872,1934,1826,1880,1997,1868,1916,1875,1943,1923,1762,1944,1914,1871,1935,1850,2019,1885,1806,1960,1767,1960,1813,1819,2143,1781,2057,1912,1721,2238,943,1655,3656,1622,956,2251,1703,1915,2072,1772,2131,1833,1817,1943,1775,1972,1789,1868,2036,1843,1922,1885,1919,1926,1769,1938,1928,1870,1933,1864,1984,1893,1829,1917,1875,1925,1844,1872,1992,1872,1860,1889,1903,1928,1805,1901,1940,1884,1912,1877,1955,1903,1838,1910,1909,1911,1870,1867,1986,1888,1846,1897,1904,1924,1816,1888,1943,1885,1888,1883,1927,1898,1828,1924,1927,1883,1880,1884,1991,1887,1844,1903,1922,1909,1827,1897,1962,1868,1869,1900,1909,1905,1818,1908,1917,1895,1887,1868,1970,1901,1839,1906,1931,1906,1853,1895,1989,1870,1872,1906,1906,1907,1815,1904,1917,1887,1879,1868,1942,1912,1812,1908,1920,1905,1867,1882,2010,1868,1878,1916,1915,1910,1836,1906,1950,1875,1896,1870,1915,1926,1769,1911,1887,1899,1861,1863,2008,1875,1855,1933,1897,1920,1867,1890,2040,1841,1971,1890,1922,1935,1707,1955,1862,1865,1894,1800,1991,1919,1640,2037,1503,2007,1694,1499,3053,2026,40,2236,2120,1668,2061,1777,1838,1974,1653,1986,1946,1894,2035,1817,2105,1875,1872,1935,1855,1936,1841,1873,1981,1861,1878,1879,1870,1939,1748,1911,1926,1879,1892,1873,1990,1885,1835,1933,1913,1902,1892,1882,1993,1877,1885,1891,1900,1927,1797,1900,1943,1882,1862,1882,1944,1897,1807,1925,1910,1890,1885,1882,1979,1886,1880,1897,1915,1924,1838,1887,1970,1883,1866,1888,1935,1898,1798,1924,1912,1881,1874,1883,1955,1892,1856,1903,1909,1920,1854,1877,1985,1886,1875,1886,1938,1921,1813,1896,1925,1894,1883,1876,1938,1891,1831,1909,1893,1913,1858,1874,1984,1884};
// Recorded under sampled signal with real transmitted data. Sample rate: 1198080
short testsignal_realundersampled_0[FSKTESTSIGNALLEN]={2867,87,2446,3870,589,1085,4018,1813,273,3382,2996,93,2289,3902,930,47,1801,3935,3379,899,82,2040,3972,3194,838,793,3849,2189,94,3039,3407,306,1736,4017,1161,196,2430,4044,2854,597,323,2458,4076,2800,420,382,2548,4061,2724,355,419,2797,4051,2502,328,548,3445,2884,64,2377,3862,797,1025,3958,1866,151,3330,3214,122,2049,3904,873,919,3947,2031,110,3018,3932,1985,61,950,3422,3916,1739,41,1134,3479,3478,337,1671,4054,1444,470,3638,2606,46,2693,3725,412,1307,4063,1576,362,3545,2784,60,2325,3809,667,1133,4010,1717,197,3414,3106,78,2151,3894,810,999,3955,2101,165,3144,3230,173,1991,4002,973,157,2287,3995,2994,695,250,2317,4030,2937,625,291,2389,4072,2854,427,347,2657,4054,2647,413,472,3619,2836,52,2438,3732,593,1267,4002,1622,271,3021,4081,2259,237,740,3066,4005,2202,185,776,3206,3146,140,2094,3984,863,798,3925,2178,112,3094,3297,210,1739,3997,1147,682,3818,2339,42,2927,3843,1503,15,1382,3619,3675,1447,4,1424,3673,3664,522,1371,4051,1521,300,3554,2886,44,2391,3775,620,1032,4035,1877,220,3332,3047,105,2225,3948,736,884,3988,2054,161,3197,3338,151,1841,3989,1050,750,3837,2212,92,3066,3461,213,1692,4022,1209,274,2578,4067,2712,461,415,2636,4075,2659,310,400,3666,2771,18,2492,3833,568,1144,4035,1744,281,3412,2921,92,2355,3872,646,1003,4012,1918,152,3224,3995,1968,105,972,3286,3901,1925,66,1011,3505,3384,185,1783,4044,1140,562,3802,2476,65,2819,3514,351,1630,4044,1240,482,3756,2632,38,2647,3712,1239,15,1679,3801,3467,1171,49,1725,3904,3476,580,1093,4006,1821,182,3339,3161,108,2097,3902,845,943,3953,1979,120,3259,3301,194,1919,4018,991,644,3884,2345,76,2945,3426,278,1743,4055,1145,513,3698,2519,46,2780,3654,358,1396,4058,1494,439,2840,4032,2428,234,602,2880,4049,2371,197,650,3112,4006,2125,183,857,3160,3938,2054,103,892,3230,3931,1984,70,966,3418,3889,1740,61,1152,3467,3348,245,1831,4034,1259,589,3732,2439,66,2865,3615,310,1486,4048,1391,479,3671,2597,29,2529,3741,542,1318,4030,1553,295,3568,2923,45,2351,3804,963,79,1964,3929,3244,919,127,2012,4005,3210,696,842,3914,2120,130,3112,3246,212,1792,3993,1077,704,3842,2284,50,3008,3511,245,1617,4035,1249,580,3747,2640,32,2666,3630,437,1450,4046,1424,346,3654,2806,61,2485,3708,548,1314,4039,1792,248,3127,3994,2133,107,832,3301,3966,1886,74,1037,3386,3128,165,1913,3941,1003,827,3875,2147,93,3102,3813,1516,5,1371,3613,3674,1465,10,1420,3682,3545,397,1548,4058,1363,410,3683,2714,47,2585,3669,476,1192,4052,1688,309,3477,2868,46,2410,3869,619,1066,3996,1857,262,3357,3185,104,2047,3925,897,208,2269,4061,2998,560,244,2488,4073,2783,513,623,3837,2417,54,2852,3469,341,1678,4033,1204,498,3792,2582,32,2731,3716,396,1347,4058,1541,386,3579,2735,38,2541,3792,520,1174,4050,1716,193,3449,3081,89,2189,3852,776,1058,3960,1892,153,3279,3873,1663,59,1064,3492,3852,1622,24,1297,3565,3712,1536,13,1372,3744,3657,1301,17,1427,3761,3593,372,1453,4042,1453,451,3617,2623,39,2674,3745,436,1276,4047,1603,252,3535,2972,51,2303,3824,688,1122,4019,1767,179,3415,3123,127,2127,3975,829,823,3943,2124,172,3142,3246,171,1970,3999,965,373,2570,4084,2709,365,425,2789,4074,2492,330,608,3717,2492,30,2772,3657,500,1420,4036,1475,336,3610,2843,43,2449,3753,592,1237,4024,1634,239,3375,2997,84,2262,3911,715,920,4003,1997,170,3232,3159,149,2109,3952,1001,791,3881,2164,86,3088,3708,1341,2,1552,3727,3549,1286,35,1611,3772,3499,386,1551,4051,1349,400,3677,2704,61,2588,3672,487,1380,4058,1689,315,3478,2872,48,2408,3860,607,1027,4025,1861,234,3344,3050,98,2038,3926,890,908,3946,2044,103,3206,3334,135,1863,3987,1041,757,3856,2396,87,2904,3450,286,1709,4048,1190,510,3010,4043,2214,185,752,3098,4027,2160,166,802,3567,2733,50,2539,3801,541,1176,4033,1712,297,3449,2896,56,2183,3882,764,1013,3977,1897,137,3302,3232,119,2003,3939,914,878,3927,2263,97,3006,3364,242,1846,3999,1050,633,3866,2414,64,2859,3466,1026,55,1881,3872,3321,1009,110,1943,3985,3264,815,149,2194,3985,3040,735,160,2257,3983,2984,686,250,2313,4039,2934,534,284,2556,4049,2715,489,321,2614,4059,2670,446,453,2677,4056,2595,315,496,2903,4050,2373,285,539,2959,4027,2288,251,710,3007,4014,2220,138,762,3236,3967,1989,116,786,3584,2875,47,2419,3774,634,1208,4018,1670,232,3467,3035,59,2239,3936,736,881,3992,2040,156,3202,3193,166,2066,3985,865,755,3941,2201,62,3052,3470,213,1692,4030,1203,625,3791,2386,37,2897,3590,315,1519,4032,1348,427,3699,2732,28,2557,3686,792,169,2162,4042,3080,615,201,2225,4055,3051,582,1029,3994,1902,230,3296,3042,132,2213,3906,782,382,2605,4078,2678,370,434,2826,4070,2445,310,614,2880,4024,2370,204,657,2942,4015,2313,183,693,3149,3993,2065,161,886,3208,3923,2010,97,942,3238,3906,1941,43,1016,3477,3873,1701,42,1201,3518,2964,89,2295,3902,865,949,3939,1949,133,3261,3282,138,1937,3964,979,805,3889,2133,92,2949,3418,271,1772,4041,1120,545,3814,2498,47,2797,3532,352,1580,4055,1479,440,3617,2685,13,2624,3752,463,1243,4038,1646,355,3513,2827,69,2258,3828,756,306,2450,4047,2822,446,342,2671,4077,2585,406,491,2764,4067,2495,334,564,2822,4040,2458,227,673,3863,2391,99,2892,3429,319,1528,4040,1371,536,3150,3969,2090,118,857,3326,3948,1844,70,1080,3393,3908,1779,75,1134,3433,3791,1728,46,1212,3610,3771,1462,20,1458,3658,3618,1401,33,1489,3666,3218,185,2000,4010,939,693,3891,2260,113,3011,3364,241,1638,4032,1240,608,3752,2435,44,2847,3619,326,1478,4052,1407,483,3667,2798,30,2497,3721,543,1304,4040,1584,264,3542,2958,45,2329,3810,667,980,4000,1948,223,3284,3067,126,2140,3951,806,468,2931,4072,2367,276,536,2971,4062,2301,216,718,3802,2307,46,2939,3558,298,1587,4031,1301,437,3735,2677,34,2638,3626,460,1444,4055,1444,350,3547,3857,1602,55,1107,3535,3843,1559,34,1353,3591,3680,1493,2,1427,3722,3641,1271,33,1487,3772,3602,1188,28,1726,3820,3411,1119,83,1768,3923,3406,225,1706,4059,1204,487,3759,2567,58,2737,3577,396,1546,4052,1337,392,3714,2742,36,2579,3789,505,1194,4048,1699,298,3470,2887,59,2397,3860,617,1035,3983,1881,144,3342,3213,106,2026,3940,898,862,3914,2043,130,3199,3322,222,1871,4013,1075,626,3193,4016,2058,152,883,3196,3930,2013,73,946,3255,3895,1941,77,999,3452,3876,1690,53,1220,3487,3756,1621,11,1287,3553,3719,1561,16,1330,3712,3122,100,2110,3884,844,985,3938,1946,148,3097,3527,1223,41,1682,3845,3483,1025,37,1924,3889,3268,958,121,2004,3941,3205,900,145,2071,4002,3196,401,1403,4056,1503,405,3578,2692,69,2428,3762,595,1241,4041,1645,227,3492,3008,52,2254,3855,721,1082,4001,2026,171,3218,3171,151,2076,3974,866,762,3943,2191,115,3089,3311,211,1709,4013,1184,643,3795,2367,74,2912,3545,276,1558,4047,1335,536,3422,3934,1781,58,1131,3438,3829,1728,6,1182,3626,2894,69,2363,3771,660,1213,3995,1915,224,3306,3624,1363,13,1530,3823,3580,1143,32,1774,3858,3213,197,1813,3980,1104,729,3817,2240,80,2993,3465,824,111,2127,3951,3117,811,105,2186,3988,3041,737,215,2289,4056,2974,543,274,2512,4049,2765,498,1110,4025,1825,227,3351,3001,128,2267,3895,695,937,4002,1989,165,3252,3296,127,1919,3979,995,783,3875,2157,73,3096,3436,202,1740,4030,1161,528,3810,2514,39,2772,3556,375,1560,4056,1312,412,3720,2698,61,2616,3736,476,1238,4042,1661,331,3439,3715,1524,31,1354,3693,3705,1313,16,1411,3747,3639,1251,15,1689,3803,3454,1175,62,1721,3909,3317,173,1867,4027,1061,600,3841,2412,70,2878,3474,322,1690,4029,1194,508,3782,2552,23,2739,3692,590,206,2416,4040,2863,587,328,2478,4068,2802,420,385,2559,4090,2704,352,434,2786,4060,2484,330,997,3957,1927,138,3274,3256,201,1976,3994,942,681,3919,2286,88,2995,3378,261,1802,4029,1099,576,3737,2456,27,2839,3641,347,1459,4057,1421,463,3651,2634,30,2665,3744,550,1267,4010,1595,273,3528,2973,51,2321,3800,683,1165,4012,1770,188,3248,3519,1236,31,1652,3880,3488,1030,31,1883,3913,3260,204,1928,4028,1184,651,3784,2344,58,2947,3534,274,1571,4050,1310,529,3724,2515,31,2600,3673,488,1388,4034,1472,357,3611,2842,42,2405,3738,632,475,2716,4067,2577,412,505,2752,4065,2518,223,560,2998,4056,2238,213,766,3075,4022,2202,182,776,3884,2223,63,3036,3483,254,1679,4018,1207,615,3773,2580,44,2719,3595,402,1515,4043,1374,369,3674,2741,40,2569,3678,524,1175,4040,1729,297,3440,2918,68,2377,3894,605,1021,4022,1894,211,3306,3059,125,2001,3927,916,892,3929,2055,88,3165,3373,816,114,2144,3975,3111,785,121,2219,3980,3043,735,255,2266,4041,2987,569,270,2505,4026,2756,528,293,2567,4042,2699,481,415,2618,4064,2673,336,473,2871,4083,2399,279,524,2908,4053,2347,254,960,3920,1980,139,3249,3266,159,1950,3932,990,652,3248,3995,1978,102,947,3287,3927,1925,44,1006,3795,2533,38,2739,3692,403,1358,4027,1497,424,3618,2717,53,2603,3762,477,1225,4057,1663,221,3476,3025,122,2236,3868,741,1060,3993,1844,160,3363,3191,80,2042,3973,876,749,3947,2225,103,3059,3325,229,1880,3997,1023,588,3870,2368,36,2888,3584,605,204,2424,4048,2842,578,339,2480,4082,2803,373,1343,4031,1536,321,3548,2898,58,2413,3781,651,567,2846,4042,2444,224,593,2889,4040,2371,229,664,3118,4025,2096,151,866,3187,3943,2066,78,898,3869,2283,76,2981,3481,266,1655,4012,1253,595,3468,3823,1711,26,1217,3503,3781,1627,20,1277,3692,2821,39,2448,3768,592,1267,3992,1613,263,3385,2982,78,2301,3915,689,945,4017,1961,188,3247,3142,130,2128,3972,988,803,3885,2145,61,3104,3423,189,1759,3997,1141,670,3836,2328,48,2776,3554,383,1594,4033,1306,449,3728,2670,36,2612,3646,507,461,2703,4069,2588,406,497,2750,4065,2516,268,551,2993,4068,2247,223,757,3035,4055,2196,196,947,3916,2023,112,3180,3325,175,1889,3936,1054,779,3357,3956,1845,68,1074,3398,3844,1789,15,1099,3768,2587,67,2693,3571,443,1341,4036,1561,399,3525,3631,1353,19,1500,3786,3608,1177,14,1720,3817,3078,85,2148,3848,803,1003,3943,1916,149,3310,3237,117,2012,3944,908,800,3927,2267,81,3003,3378,235,1823,4030,1078,592,3849,2414,48,2842,3496,329,1457,4060,1422,468,3642,2621,44,2675,3732,431,1296,4031,1574,401,3532,2936,37,2342,3810,677,670,2996,4035,2277,151,716,3190,4016,2033,122,860,3953,2133,128,3094,3273,199,1930,4004,966,684,3904,2312,100,2974,3504,252,1612,4047,1269,564,3592,3706,1499,6,1390,3739,3701,1276,0,1422,3785,2833,46,2439,3715,598,1273,4011,1616,281,3532,3403,908,49,1822,3937,3353,881,73,2038,3971,3104,150,2107,4002,862,775,3922,2168,98,3092,3430,195,1744,4033,1194,646,3816,2349,27,2933,3553,281,1559,4062,1308,417,3700,2706,56,2606,3670,486,1400,4048,1485,325,3603,2863,59,2428,3854,601,1065,4036,1839,275,3364,2982,80,2270,3947,765,878,3257,3905,1968,87,958,3417,3903,1703,57,1175,3471,3755,1645,39,1257,3517,3730,1589,35,1315,3672,3678,1342,10,1561,3734,3546,1280,52,1604,3762,2758,59,2525,3831,555,1128,4009,1752,301,3423,2922,77,2372,3856,789,1029,3977,1886,130,3287,3292,693,161,2317,4026,2973,668,265,2348,4050,2922,250,1785,4052,1113,572,3827,2462,81,2821,3501,336,1627,4059,1459,448,3641,2634,35,2668,3741,443,1276,4054,1601,356,3571,2815,61,2298,3836,684,1118,4005,1767,172,3406,3129,64,2132,3911,825,962,3960,2152,143,3126,3244,190,1964,3983,969,699,3626,3794,1469,7,1421,3656,3762,1430,4,1453,3713,2509,51,2767,3655,391,1402,4048,1476,438,3607,3548,1074,26,1836,3877,3364,1034,91,1897,3981,3005,69,2202,3876,757,871,3962,2063,175,3186,3195,153,2054,3976,880,771,3930,2210,92,3052,3315,470,277,2585,4071,2691,508,422,2638,4091,2644,295,1510,4050,1378,488,3660,2762,43,2549,3691,518,1349,4060,1562,295,3576,2923,40,2372,3781,636,1011,4013,1901,220,3320,3058,117,2197,3952,763,865,3993,2071,140,3176,3369,154,1839,3989,1078,721,3842,2258,69,3021,3464,236,1676,4046,1235,468,3748,3619,1198,45,1688,3786,3473,1168,65,1729,3914,3398,929,84,1848,3948,3321,869,115,2068,3967,2915,100,2317,3916,698,955,3988,1966,123,3261,3275,141,1928,3957,959,815,3898,2137,68,3135,3415,188,1774,4021,1130,576,3827,2477,51,2791,3518,359,577,2893,4046,2366,153,622,2929,4030,2351,172,1238,4032,1653,301,3454,2880,110,2435,3852,599,1069,4000,1842,168,3364,3170,79,2055,3897,868,918,3936,2011,119,3231,3310,218,1901,4022,1018,626,3877,2384,53,2905,3448,286,1723,4060,1168,513,3698,2547,46,2737,3662,393,1400,4040,1509,402,3591,3282,934,107,1997,3933,3218,893,124,2092,4028,3051,85,2174,3888,790,999,3941,1896,157,3156,3237,169,2019,3998,914,720,3916,2253,86,3014,3362,254,1853,4024,1240,591,3777,2418,25,2857,3615,310,1478,4050,1418,506,3681,2577,36,2508,3714,555,793,3156,3973,2082,83,860,3336,3959,1854,57,1166,4007,1968,181,3247,3144,151,2121,3944,817,810,3951,2134,140,3126,3262,187,1777,4018,1119,675,3823,2308,61,2967,3536,257,1595,4031,1279,579,3741,2675,28,2626,3647,468,1420,4054,1454,334,3645,2787,46,2451,3722,585,1109,4029,1794,261,3362,3054,714,267,2282,4046,2988,553,248,2516,4050,2755,521,300,2577,4041,2688,458,435,2648,4047,2622,328,484,2883,4049,2390,295,525,2933,4045,2342,275,698,2995,3996,2271,163,731,3190,3986,2018,142,763,3269,3924,1950,106,988,3308,3882,1895,45,1051,4009,1910,187,3292,3254,140,1982,3938,930,868,3923,2067,88,3168,3361,158,1828,3999,1078,579,3844,2452,58,2850,3498,321,1655,4045,1242,455,3766,2606,21,2682,3738,431,1295,4068,1638,344,3541,2788,42,2505,3829,551,1120,4034,1758,183,3388,3134,86,2141,3850,818,999,3966,1920,147,3264,3243,339,369,2581,4074,2692,350,412,2809,4088,2464,296,1787,4040,1168,561,3801,2471,46,2797,3624,382,682,3165,3997,2045,164,850,3191,3948,2007,75,932,3238,3896,1953,88,1016,3451,3880,1721,73,1207,3484,3774,1623,7,1279,3529,3707,1573,17,1299,3917,2198,103,3048,3322,232,1902,4008,1019,643,3797,2363,46,2924,3556,254,1539,4054,1340,523,3705,2543,39,2761,3685,495,1347,4087,1509,307,3600,2877,30,2393,3772,625,1208,4024,1645,247,3334,3044,115,2224,3938,740,890,3973,2041,172,3222,3178,152,2061,3978,1057,794,3863,2190,62,3049,3472,210,569,3032,4034,2237,215,759,3091,4032,2159,185,817,3150,3964,2061,84,899,3355,3919,1835,64,1331,4025,1748,305,3392,2919,94,2358,3869,671,1010,3603,3791,1480,28,1350,3617,3767,1429,19,1494,3670,3616,1347,19,1558,3810,3558,1127,32,1767,3865,2480,63,2798,3545,374,1598,4000,1273,454,3760,2649,18,2632,3647,448,1254,4067,1626,349,3488,2824,53,2472,3828,578,1089,4038,1809,256,3426,3145,87,2102,3910,842,943,3957,1979,109,3240,3285,154,1926,3968,987,809,3888,2357,71,2970,3450,284,1742,4025,1132,571,3817,2498,57,2778,3538,395,818,3302,3972,1912,101,1013,3341,3883,1864,35,1226,4075,1673,330,3470,3041,92,2229,3837,740,1065,3993,1806,179,3366,3149,101,2085,3917,871,776,3807,3612,1207,59,1709,3794,3460,1150,65,1776,3911,3390,919,72,1862,3930,3317,868,102,2088,3967,2594,52,2698,3719,426,1328,4038,1568,297,3557,2946,52,2341,3807,666,1154,4041,1709,203,3433,3086,70,2164,3952,805,843,3968,2107,95,3144,3243,182,1984,3998,929,702,3920,2282,49,3017,3496,244,1635,4042,1254,590,3747,2454,37,2842,3634,322,1448,4039,1426,380,3646,2764,32,2511,3733,557,1203,3502,3757,1618,29,1249,3529,3760,1560,22,1324,3692,3667,1336,44,1575,3720,3538,1278,58,1628,3750,3503,1171,37,1710,3892,3435,995,82,1940,3960,2345,57,2933,3536,395,1567,4012,1312,429,3698,3170,686,146,2318,4001,2946,652,250,2358,4042,2856,81,2405,3871,640,1009,4005,1886,230,3328,3051,99,2217,3938,908,882,3932,2041,63,3179,3355,163,1844,3978,1055,751,3868,2228,68,2870,3477,307,1675,4050,1205,490,3771,2597,35,2716,3583,449,1510,4050,1579,378,3569,2760,41,2540,3811,533,1138,4037,1741,304,3431,2886,93,2189,3867,795,1016,3690,3581,1343,21,1551,3821,3585,1130,25,1785,3899,2304,85,2982,3368,281,1815,4013,1106,593,3805,3306,810,91,2148,4004,3255,767,116,2206,4005,2657,67,2640,3731,509,1267,4020,1634,366,3505,3039,498,263,2584,4075,2710,486,407,2625,4095,2666,112,2081,3927,877,903,3929,2225,123,3060,3309,211,1900,4016,1007,641,3875,2370,55,2932,3444,287,1532,4059,1347,526,3689,2543,31,2757,3667,381,1376,4054,1519,412,3592,2897,36,2398,3784,628,1173,4023,1688,213,3474,3052,59,2213,3864,748,874,4006,2049,188,3148,3172,152,2076,3975,905,761,3916,3423,955,75,1794,3904,3388,898,75,2051,3934,3164,840,161,2141,4024,3106,664,192,2197,4036,2757,37,2494,3711,553,1304,4031,1583,300,3558,2940,47,2347,3880,666,1013,4000,1910,204,3284,3084,307,562,2857,4047,2438,225,592,2903,4037,2361,182,1769,4004,1126,675,3797,2317,74,2960,3533,268,1609,4055,1261,442,3733,2657,30,2643,3643,453,1441,4053,1449,336,3644,2829,47,2459,3837,567,1104,4041,1819,263,3388,2983,88,2290,3915,707,911,3948,1983,107,3250,3315,135,1916,3963,956,810,3880,2150,87,3072,3403,292,1772,4039,1141,551,3801,3196,704,142,2293,4023,2981,670,240,2347,4042,2693,68,2573,3777,511,1172,4016,1700,333,3469,2876,63,2411,3858,751,1043,3995,1862,148,3346,3209,105,2043,3915,902,917,3928,2010,114,3034,3326,244,767,3115,3975,2130,115,823,3312,3982,1866,84,1668,4030,1425,471,3646,2626,73,2693,3716,410,1302,4052,1570,380,3571,2761,39,2338,3811,660,1167,4011,1741,205,3442,3089,53,2166,3884,776,998,3969,2110,143,3142,3244,186,1987,4020,929,687,3912,2293,93,2993,3381,242,1613,4040,1262,575,3741,2466,48,2832,3601,351,1485,4052,1411,474,3638,2944,507,275,2549,4048,2730,482,413,2641,4082,2653,336,467,2865,4090,2608,310,510,2908,4046,2349,280,676,2966,4010,2293,165,722,3181,3981,2035,158,769,3237,3981,1964,113,970,3285,3876,1932,50,1530,4027,1359,491,3683,2760,59,2547,3676,508,1370,4042,1509,293,3595,2911,40,2392,3785,624,1032,4029,1883,208,3325,3047,96,2207,3940,787,879,3991,2060,147,3187,3354,165,1840,4001,1063,739,3849,2227,53,3025,3485,243,1667,4018,1207,488,3777,2596,56,2702,3601,417,1500,4054,1382,373,3673,2771,36,2529,3796,528,1184,4031,1718,276,3426,2894,334,558,2848,4061,2441,220,591,2892,4052,2388,157,1966,3931,982,847,3871,2102,96,3118,3376,189,882,3222,3936,2011,101,930,3396,3926,1752,76,1168,3463,3793,1664,20,1245,3502,3749,1623,3,1310,4037,1641,327,3488,2853,91,2453,3806,577,1091,4002,1821,169,3386,3157,74,2091,3909,858,930,3948,1988,119,3243,3308,206,1914,4023,999,636,3879,2356,71,2924,3421,279,1740,4055,1172,531,3698,2533,35,2762,3677,375,1373,4082,1501,429,3607,2681,46,2585,3767,604,1216,4031,1676,224,3486,3046,66,2233,3849,741,1098,3992,1832,162,3200,3173,165,768,3105,3962,2151,134,817,3304,3959,1882,98,1062,3372,3925,1786,59,1121,3420,3821,1764,19,1504,4038,1391,506,3643,2570,56,2534,3688,537,1333,3664,3644,1388,15,1486,3772,3615,1176,21,1726,3966,1950,197,3265,3118,136,2137,3936,804,838,3978,2118,127,3157,3240,165,1783,4013,1106,697,3837,2291,51,2987,3528,265,1612,4028,1259,574,3746,2638,53,2643,3644,453,1453,4046,1433,345,3634,2818,33,2497,3744,560,1100,4044,1801,258,3392,2974,89,2307,3912,687,947,4015,1969,176,3256,3276,118,1924,3954,1004,833,3891,2107,110,3119,3417,227,1005,3512,3867,1628,28,1073,3538,3849,1595,2,1585,4022,1287,416,3687,2680,78,2593,3699};

/*
	Generate a signal with 0,1 and benchmark demodulation of frames.
*/
void fsk_demod_test_1()
{
	// Simulate undersampled data
	int sr = 1198080;
	int fc = 299520;
	int br=115200;
	int f0 = fc-br/2;
	int f1 = fc+br/2;

	//unsigned short data[CICBUFSIZ*4];
	signed short data[CICBUFSIZ];
	unsigned datalen=sizeof(data)/sizeof(unsigned short);

	fprintf(file_pri,"Test data lenghth: %d\n",datalen);
	fprintf(file_pri,"Float: %f\n",3.141592);

	fsk_gentestsignal(data,datalen,sr,f0,f1,br);

	fprintf(file_pri,"Data: "); print_array_short(file_pri,data,datalen);

	fsk_demod_bench(data,datalen);
}
/*
	Generate a signal with well known artificial spectrum, and print I, Q and CP after each frame.
*/
void fsk_demod_test_2()
{
	// Generate well recognised spectrum.
	// Simulate undersampled data
	//int sr = 1198080;
	//int fc = 299520;
	//int br=115200;
	//int f0 = fc-br/2;
	//int f1 = fc+br/2;


	signed short data[FSKTESTSIGNALLEN];			// Same length as matlab
	unsigned datalen=sizeof(data)/sizeof(unsigned short);


	fprintf(file_pri,"Test data lenghth: %d\n",datalen);
	fprintf(file_pri,"Float: %f\n",3.141592);
	// Clear target
	for(int i=0;i<datalen;i++)
		data[i] = 0;

	//fsk_gentestsignal2(data,datalen,sr,fc,bfs,bff);
	fsk_gentestsignal2b(data);

	fprintf(file_pri,"Data: "); print_array_short(file_pri,data,datalen);

	// Step-by-step demodulation.
	// Number of frames
	int nf = FSKTESTSIGNALLEN/CICBUFSIZ;

	unsigned log=0;
	FILE *file = ufat_log_open(log);
	if(!file)
	{
		fprintf(file_pri,"Error opening log %d\n",log);
		return;
	}

	fsk_demod_init();
	for(int fi=0;fi<nf;fi++)
	//for(int fi=0;fi<1;fi++)
	{
		fprintf(file_pri,"Processing frame %d out of %d\n",fi,nf);
		fprintf(file_pri,"Data: "); print_array_short(file_pri,&data[fi*CICBUFSIZ],CICBUFSIZ);
		// Initialise the internal buffers for easy debugging
		for(unsigned i=0;i<CICBUFSIZ/2;i++)
		{
			_fsk_di[i+1]=_fsk_dq[i+1]=0xfffff;		// +1 as di,dq has +1 size
			_fsk_cp[i]=0xfffff;
		}
		//CICBUFSIZ

		fsk_demod_frame(&data[fi*CICBUFSIZ],_fsk_binary,1);

		fprintf(file_pri,"I:\n"); for(unsigned i=0;i<CICBUFSIZ/2;i++) fprintf(file_pri,"%d ",_fsk_di[i+1]>>8); fprintf(file_pri,"\n");
		fprintf(file_pri,"Q:\n"); for(unsigned i=0;i<CICBUFSIZ/2;i++) fprintf(file_pri,"%d ",_fsk_dq[i+1]>>8); fprintf(file_pri,"\n");
		//fprintf(file_pri,"CP:\n"); for(unsigned i=0;i<CICBUFSIZ/2;i++) fprintf(file_pri,"%d ",_fsk_cp[i]); fprintf(file_pri,"\n");
		fprintf(file_pri,"CPsign:\n"); for(unsigned i=0;i<CICBUFSIZ/2;i++) fprintf(file_pri,"%d ",_fsk_binary[i]); fprintf(file_pri,"\n");

		fprintf(file,"I:\n"); for(unsigned i=0;i<CICBUFSIZ/2;i++) fprintf(file,"%d ",_fsk_di[i+1]>>8); fprintf(file,"\n");
		fprintf(file,"Q:\n"); for(unsigned i=0;i<CICBUFSIZ/2;i++) fprintf(file,"%d ",_fsk_dq[i+1]>>8); fprintf(file,"\n");
		//fprintf(file,"CP:\n"); for(unsigned i=0;i<CICBUFSIZ/2;i++) fprintf(file,"%d ",_fsk_cp[i]); fprintf(file,"\n");
		fprintf(file,"CPsign:\n"); for(unsigned i=0;i<CICBUFSIZ/2;i++) fprintf(file,"%d ",_fsk_binary[i]); fprintf(file,"\n");


	}
	ufat_log_close();

}


/*
	Generate a signal with 1,0, and print I, Q and CP after each frame.
*/
void fsk_demod_test_3()
{
	// Simulate undersampled data
	int sr = 1198080;
	int fc = 299520;
	int br=115200;
	int f0 = fc-br/2;
	int f1 = fc+br/2;

	signed short data[CICBUFSIZ*3];
	//unsigned short data[CICBUFSIZ];
	unsigned datalen=sizeof(data)/sizeof(unsigned short);

	fprintf(file_pri,"Test data lenghth: %d\n",datalen);
	fprintf(file_pri,"Float: %f\n",3.141592);

	fsk_gentestsignal(data,datalen,sr,f0,f1,br);

	fprintf(file_pri,"Data: "); print_array_short(file_pri,data,datalen);


	// Step-by-step demodulation.
	// Number of frames
	int nf = FSKTESTSIGNALLEN/CICBUFSIZ;

	/*unsigned log=0;
	FILE *file = ufat_log_open(log);
	if(!file)
	{
		fprintf(file_pri,"Error opening log %d\n",log);
		return 1;
	}*/

	fsk_demod_init();
	for(int fi=0;fi<nf;fi++)
	//for(int fi=0;fi<1;fi++)
	{
		fprintf(file_pri,"Processing frame %d out of %d\n",fi,nf);
		fprintf(file_pri,"Data: "); print_array_short(file_pri,&data[fi*CICBUFSIZ],CICBUFSIZ);
		// Initialise the internal buffers for easy debugging
		for(unsigned i=0;i<CICBUFSIZ/2;i++)
		{
			_fsk_di[i+1]=_fsk_dq[i+1]=0xfffff;		// +1 as di,dq has +1 size
			_fsk_cp[i]=0xfffff;
		}
		//CICBUFSIZ

		fsk_demod_frame(&data[fi*CICBUFSIZ],_fsk_binary,1);

		fprintf(file_pri,"I:\n"); for(unsigned i=0;i<CICBUFSIZ/2;i++) fprintf(file_pri,"%d ",_fsk_di[i+1]>>8); fprintf(file_pri,"\n");
		fprintf(file_pri,"Q:\n"); for(unsigned i=0;i<CICBUFSIZ/2;i++) fprintf(file_pri,"%d ",_fsk_dq[i+1]>>8); fprintf(file_pri,"\n");
		//fprintf(file_pri,"CP:\n"); for(unsigned i=0;i<CICBUFSIZ/2;i++) fprintf(file_pri,"%d ",_fsk_cp[i]); fprintf(file_pri,"\n");
		fprintf(file_pri,"CPsign:\n"); for(unsigned i=0;i<CICBUFSIZ/2;i++) fprintf(file_pri,"%d ",_fsk_binary[i]); fprintf(file_pri,"\n");

		/*fprintf(file,"I:\n"); for(unsigned i=0;i<CICBUFSIZ/2;i++) fprintf(file,"%d ",_fsk_di[i+1]>>8); fprintf(file,"\n");
		fprintf(file,"Q:\n"); for(unsigned i=0;i<CICBUFSIZ/2;i++) fprintf(file,"%d ",_fsk_dq[i+1]>>8); fprintf(file,"\n");
		fprintf(file,"CP:\n"); for(unsigned i=0;i<CICBUFSIZ/2;i++) fprintf(file,"%d ",_fsk_cp[i]); fprintf(file,"\n");*/


	}
	//ufat_log_close();

}
/*
 Real data demodulation
*/
void fsk_demod_test_4()		// Real undersampled recording
{

	//int sr = 1198080;
	//int fc = 299520;
	//int br=115200;
	//int f0 = fc-br/2;
	//int f1 = fc+br/2;


	signed short data[FSKTESTSIGNALLEN];			// Same length as matlab
	unsigned datalen=sizeof(data)/sizeof(unsigned short);


	fprintf(file_pri,"Test data lenghth: %d\n",datalen);
	fprintf(file_pri,"Float: %f\n",3.141592);
	// Clear target
	for(int i=0;i<datalen;i++)
		data[i] = 0;


	fsk_gentestsignal3(data);

	fprintf(file_pri,"Data: "); print_array_short(file_pri,data,datalen);

	// Step-by-step demodulation.
	// Number of frames
	int nf = FSKTESTSIGNALLEN/CICBUFSIZ;

	/*unsigned log=0;
	FILE *file = ufat_log_open(log);
	if(!file)
	{
		fprintf(file_pri,"Error opening log %d\n",log);
		return 1;
	}*/

	fsk_demod_init();
	for(int fi=0;fi<nf;fi++)
	//for(int fi=0;fi<1;fi++)
	{
		fprintf(file_pri,"Processing frame %d out of %d\n",fi,nf);
		fprintf(file_pri,"Data: "); print_array_short(file_pri,&data[fi*CICBUFSIZ],CICBUFSIZ);
		// Initialise the internal buffers for easy debugging
		for(unsigned i=0;i<CICBUFSIZ/2;i++)
		{
			_fsk_di[i+1]=_fsk_dq[i+1]=0xfffff;		// +1 as di,dq has +1 size
			_fsk_cp[i]=0xfffff;
		}
		//CICBUFSIZ

		fsk_demod_frame(&data[fi*CICBUFSIZ],_fsk_binary,1);

		fprintf(file_pri,"I:\n"); for(unsigned i=0;i<CICBUFSIZ/2;i++) fprintf(file_pri,"%d ",_fsk_di[i+1]>>8); fprintf(file_pri,"\n");
		fprintf(file_pri,"Q:\n"); for(unsigned i=0;i<CICBUFSIZ/2;i++) fprintf(file_pri,"%d ",_fsk_dq[i+1]>>8); fprintf(file_pri,"\n");
		//fprintf(file_pri,"CP:\n"); for(unsigned i=0;i<CICBUFSIZ/2;i++) fprintf(file_pri,"%d ",_fsk_cp[i]); fprintf(file_pri,"\n");
		fprintf(file_pri,"CPsign:\n"); for(unsigned i=0;i<CICBUFSIZ/2;i++) fprintf(file_pri,"%d ",_fsk_binary[i]); fprintf(file_pri,"\n");

		/*fprintf(file,"I:\n"); for(unsigned i=0;i<CICBUFSIZ/2;i++) fprintf(file,"%d ",_fsk_di[i+1]>>8); fprintf(file,"\n");
		fprintf(file,"Q:\n"); for(unsigned i=0;i<CICBUFSIZ/2;i++) fprintf(file,"%d ",_fsk_dq[i+1]>>8); fprintf(file,"\n");
		fprintf(file,"CP:\n"); for(unsigned i=0;i<CICBUFSIZ/2;i++) fprintf(file,"%d ",_fsk_cp[i]); fprintf(file,"\n");*/


	}
	//ufat_log_close();


}


signed short tmpdata[CICBUFSIZ];
/*
	ADC data is 12-bit unsigned, i.e. 13-bit signed.
	Mean removal may not change to 12-bit depending on data distribution, hence input to CIC is 13-bit
	CIC bit growth in worst case is order-1 bits, i.e. 4 bits for 5th order. This is due to 1st stage alternating 0,
	hence the 1st stage imposes no bit growth.

	Alternative 1.
	1. ADC: 13-bit signed
	2. Mean subtract: 13-bit signed
	3. CIC: 17-bit signed


	adc: 13bit -4096-+4095
	adcms: 13 bit -4096-+4095
	cic5: 17 bit -65536-+65535
	cp: -65536*-65536=2^32->error		input must be 16-bit max

	cic5
	sr1: 16 bit -32768-+32767
	cp: -(-32768*-32768)=-1m -> -32768*-32768=1m,2^30 -> 31bit, but can't represent max positive (unlikely so no problem). 32 ok

Alternative 1: CIC5 result on on 32-bit, shift right by 1 (+8 to remove info bits) and feed to CP.

Alternative 2: shift left by 7, CIC5 result on 16-bit, do 16-bit DMA tranfer !!!!! CAN'T WORK, as input of CIC is 16-bit. Max shift left is 4.
	adcms: 13 bit -4096-+4095
	acdms_sl7: 20 bit -524288 -> + 524287
	cic5: 24 bit: -8m -> +8m
	cic5_16msb: 16 upper bits of 24-bit -32768 -> +32767
	cp: -(-32768*-32768)=-1m -> -32768*-32768=1m,2^30 -> 31bit, but can't represent max positive (unlikely so no problem). 32 ok


	cp: 2^n input (n+1 bit)->2^(2n) output

	sr16
	cic bit integration

*/
void fsk_demod_init()
{
	// Call once

	//dsp_real_to_iq_4x_cic_init_dma(_fsk_downsampling,5,0);
	//dsp_real_to_iq_4x_cic_init_dma(_fsk_downsampling,5);		// Used version
	//dsp_real_to_iq_4x_cic_init_dma(_fsk_downsampling,1);

	dsp_real_to_iq_4x_cic_init_cpu(_fsk_downsampling,5);
}
/******************************************************************************
function: fsk_demod_frame
*******************************************************************************

Demodulates a frame of 16-bit input data.

Parameters:
	data		-	Array of 16-bit samples
	binaryout	-	Array of binary demodulated output
	debug		-	Whether to print debug info (1, or 2 for verbose).

Returns:
	-

Benchmarks

	32-bit CIC with blocking CPU read
		dsp_crossproductsign_stream_sr			2005/s
	16-bit CIC with blocking CPU read
		dsp_crossproductsign_stream_in16		1971/s
		dsp_crossproductsign_stream_in16_simd	2088/s
		dsp_crossproductsign_stream_in16_simd_2	2154/s
		dsp_crossproductsign_stream_in16_simd_3	2156/s

	32-bit CIC with nop CPU read
		dsp_crossproductsign_stream_sr			2552/s
	16-bit CIC with nop CPU read
		dsp_crossproductsign_stream_in16		2642/s
		dsp_crossproductsign_stream_in16_simd	2856/s
		dsp_crossproductsign_stream_in16_simd_2	2980/s
		dsp_crossproductsign_stream_in16_simd_3	2984/s


******************************************************************************/
unsigned fsk_demod_frame(signed short * restrict data,unsigned char *restrict binaryout,unsigned debug)
{
	unsigned t1,t2,t3,t4,t5;
	unsigned tt1,tt2,tt3;
	// Call after every new data frame
	// Data frame is assumed to be CICBUFSIZ in length

	// === Calculate mean ===
	if(debug) t1 = timer_us_get();
	signed mean = dsp_mean_simd_12u_16u(data,CICBUFSIZ);
	if(debug) t2 = timer_us_get();


	// Print
	//print_array_short(data,CICBUFSIZ);

	// === Convert to IQ with CIC low-pass filtering and downsampling ===
	//dsp_real_to_iq_4x_cic_process_dma(data,_fsk_di+1,_fsk_dq+1,CICBUFSIZ,mean);		// +1 to keep IQ sample of previous frame.

#if DSP_FSK_USE_CIC_16BIT==1
	dsp_real_to_iq_4x_cic_process_cpu_msb(data,_fsk_dis+1,_fsk_dqs+1,CICBUFSIZ,mean);		// 16-bit result instead of 32.
#else
	dsp_real_to_iq_4x_cic_process_cpu(data,_fsk_di+1,_fsk_dq+1,CICBUFSIZ,mean);		// +1 to keep IQ sample of previous frame.
#endif

	if(debug) t3 = timer_us_get();

	/*if(debug)
	{
		tt1 = timer_us_get();
		dsp_real_to_iq_4x_split(data,_fsk_tmp_di,_fsk_tmp_dq,CICBUFSIZ,mean);		// Trial to split adc into IQ lane to postpone CIC filtering by feeding with DMA
		tt2 = timer_us_get();

	}*/



	// === Direction of rotation through cross-product ===
	if(debug==2) tt1 = timer_us_get();
#if DSP_FSK_USE_CIC_16BIT==1
	//dsp_crossproductsign_stream_in16(_fsk_dis,_fsk_dqs,binaryout,CICBUFSIZ/2,12);
	//dsp_crossproductsign_stream_in16_simd(_fsk_dis,_fsk_dqs,binaryout,CICBUFSIZ/2,12);
	//dsp_crossproductsign_stream_in16_simd_2(_fsk_dis,_fsk_dqs,binaryout,CICBUFSIZ/2,12);
	dsp_crossproductsign_stream_in16_simd_3(_fsk_dis,_fsk_dqs,binaryout,CICBUFSIZ/2,12);
#else
	//dsp_crossproduct_stream_sr(_fsk_di,_fsk_dq,_fsk_cp,CICBUFSIZ/2,12);
	dsp_crossproductsign_stream_sr(_fsk_di,_fsk_dq,binaryout,CICBUFSIZ/2,12);			// Calculate sign of crossproduct and store directly in bit vector
#endif

	//dsp_crossproduct_stream_h16(_fsk_di,_fsk_dq,_fsk_cp2,CICBUFSIZ/2);
	//dsp_crossproduct_stream_h16_simd(_fsk_di,_fsk_dq,_fsk_cp3,CICBUFSIZ/2);
	if(debug==2) tt2 = timer_us_get();
	if(debug==2) fprintf(file_pri,"cp: %u us\n",tt2-tt1);
#if 0
	{
		tt1 = timer_us_get();
		//dsp_crossproduct_stream_sr2(_fsk_di,_fsk_dq,_fsk_cp2,CICBUFSIZ/2,12);
		//dsp_crossproduct_stream_h16_simd(_fsk_di,_fsk_dq,_fsk_cp3,CICBUFSIZ/2);
		for(unsigned i=0;i<100;i++)
		dsp_crossproductsign_stream_in16_simd_3(_fsk_dis,_fsk_dqs,_fsk_binary2,CICBUFSIZ/2,12);
		//dsp_crossproduct_stream_h16(_fsk_di,_fsk_dq,_fsk_cp2,CICBUFSIZ/2);
		//dsp_crossproduct_stream_h16_2(_fsk_di,_fsk_dq,_fsk_cp2,CICBUFSIZ/2);
		tt2 = timer_us_get();
		for(unsigned i=0;i<100;i++)
		dsp_crossproductsign_stream_in16_simd_2(_fsk_dis,_fsk_dqs,_fsk_binary3,CICBUFSIZ/2,12);
		//dsp_crossproduct_stream_sr2(_fsk_di,_fsk_dq,_fsk_cp2,CICBUFSIZ/2,12);
		//dsp_crossproduct_stream_h16(_fsk_di,_fsk_dq,_fsk_cp3,CICBUFSIZ/2);
		//dsp_crossproduct_stream_h16(_fsk_di,_fsk_dq,_fsk_cp2,CICBUFSIZ/2);
		tt3 = timer_us_get();
		for(unsigned s=0;s<4;s++)
		{
			for(unsigned i=s*128;i<s*128+128;i++)
				fprintf(file_pri,"%d",binaryout[i]);
			fprintf(file_pri,"\n");
			for(unsigned i=s*128;i<s*128+128;i++)
				fprintf(file_pri,"%d",_fsk_binary2[i]);
			fprintf(file_pri,"\n");
			for(unsigned i=s*128;i<s*128+128;i++)
				fprintf(file_pri,"%d",_fsk_binary3[i]);
			fprintf(file_pri,"\n");
			fprintf(file_pri,"\n");
		}

		// compare
		unsigned eq=1;
		for(unsigned i=0;i<CICBUFSIZ/2;i++)
		{
			//if(_fsk_cp[i]!=_fsk_cp2[i])
			//if(_fsk_cp2[i]!=_fsk_cp3[i])
			if( (binaryout[i]!=_fsk_binary2[i]) || (_fsk_binary2[i]!=_fsk_binary3[i]) )
			{
				//fprintf(file_pri,"Mismatch at %d: %d %d %d\n",i,binaryout[i],_fsk_binary2[i],_fsk_binary3[i]);
				eq=0;
				break;
			}
		}
		fprintf(file_pri,"cp, cp2 equal: %d\n",eq);
		if(debug==2)
		{
			fprintf(file_pri,"cp2: %u us\n",tt2-tt1);
			fprintf(file_pri,"cp3: %u us\n",tt3-tt2);
		}
	}
#endif

	if(debug) t4 = timer_us_get();

	// === Prepare for next frame streaming processing ===
	// The last I and Q sample is copied at the "past" IQ location to ensure streaming of crossproduct
#if DSP_FSK_USE_CIC_16BIT==1
	_fsk_dis[0] = _fsk_dis[CICBUFSIZ/2];		// Last sample of "current" frame copied to last sample of "previous" frame
	_fsk_dqs[0] = _fsk_dqs[CICBUFSIZ/2];		// Last sample of "current" frame copied to last sample of "previous" frame
#else
	_fsk_di[0] = _fsk_di[CICBUFSIZ/2];		// Last sample of "current" frame copied to last sample of "previous" frame
	_fsk_dq[0] = _fsk_dq[CICBUFSIZ/2];		// Last sample of "current" frame copied to last sample of "previous" frame
#endif


	if(debug) t5 = timer_us_get();


	unsigned t=0;
	if(debug)
	{
		t += t2-t1;
		t += t3-t2;
		t += t4-t3;
		t += t5-t4;

		if(debug==2) fprintf(file_pri,"Mean: %d\n",mean);
		if(debug==2) fprintf(file_pri,"%u %u %u %u\n",t2-t1,t3-t2,t4-t3,t5-t4);
		//if(debug==2) fprintf(file_pri,"split %u\n",tt2-tt1);
	}
	return t;
}


void fsk_demod_bench(signed short * restrict data,int len)
{
	unsigned t1,t2;
	if(len!=CICBUFSIZ)
	{
		fprintf(file_pri,"Invalid length\n");
		return;
	}



	fsk_demod_init();

	unsigned t_last=timer_s_wait(),t_cur;
	unsigned tint1=timer_ms_get_intclk();
	unsigned nsample=0;
	unsigned mintime=1;
	while((t_cur=timer_s_get())-t_last<mintime)
	{
		fsk_demod_frame(data,_fsk_binary,0);
		nsample++;
		//break;	// do once only
	}
	unsigned tint2=timer_ms_get_intclk();
	fprintf(file_pri,"Time: %ds (%lu intclk ms) Frames: %lu. Frames/sec: %lu\n",t_cur-t_last,tint2-tint1,nsample,nsample/(t_cur-t_last));



}
/*
 Generate a test signal alternating f0, f1 at br intervals.
 Phase continuous
*/
void fsk_gentestsignal(signed short *target,int len,int sr,int f0,int f1,int br)
{
	float dt = 1.0/sr;
	float pi = 3.14159265358979323846;
	float bt = 1.0/br; 	// Bit duration
	// y = cos( w * dt * i ) with dt time in-between samples, i index of sample. I.e. phase increment is equal to w*dt

	float w[2] = {2*pi*f0, 2*pi*f1};		// Possible phase increments
	float ph=0;	// Current phase
	for(unsigned i=0;i<len;i++)
	{
		target[i] = (short)(cos(ph)*1023.0+1024.0);

		int b = (dt*i)/bt;	// Current bit
		b=b%2;				// Bit 0 or 1
		ph+=w[b]*dt;		// Increment phase according to
	}



}


/*
 Generate a test signal with a well defined shape.
 Generate rising amplitude from fc-bfs/2 to fc+bfs/2
 Generate rising but lower amplitude from fc+bfs/2 to fc+bff/2; and from -fc-bff/2 to -fc-bfs/2
*/
void fsk_gentestsignal2(signed short *target,int len,int sr,int fc,float bfs, float bff)
{
	float dt = 1.0/sr;
	float pi = 3.14159265358979323846;
	// y = cos( w * dt * i ) with dt time in-between samples, i index of sample. I.e. phase increment is equal to w*dt

	float ampmul = 16.0;		// Ensure a "unit" cosine is has ampmul peak amplitude.

	int nl = 50;		// Number of cosines to generate.
	// Add signal to bandpass
	// Left half
	float fi=0;
	fprintf(file_pri,"Adding to bandpass: lower\n");
	for(float f = fc-bfs/2; f<fc; f+=bfs/nl)
	//float f = fc;
	{
		float amp = 1.5+3.0*fi;
		dsp_addcoswave(target,len,sr,f,amp*ampmul,0);
		//tmp_s=tmp_s*(1.5+3*fi);
		fi=fi+1.0/nl;
	}
	// Right half
	fprintf(file_pri,"Adding to bandpass: upper\n");
	for(float f=fc; f<fc+bfs/2; f+=bfs/nl)
	{
		float amp = 1.5+3.0*fi;
		dsp_addcoswave(target,len,sr,f,amp*ampmul,0);
		//tmp_s=tmp_s*(1.5+3*fi);
		fi=fi+1/nl;
	}
	// Add to filter bandpass
	// Upper
	nl=50;
	fi=0;
	float sc=1.25;
	//fr1=[fc+bfs/2:(bff-bfs)/2/nl:fc+bff/2];
	//fr2=[fc+bff/2:-(bff-bfs)/2/nl:fc+bfs/2];
	fprintf(file_pri,"Adding to noise bandpass: upper\n");
	for(float f = fc+bfs/2; f<fc+bff/2; f+=(bff-bfs)/2.0/nl)
	{
		float amp = 1.0/sc/nl*fi;
		dsp_addcoswave(target,len,sr,f,amp*ampmul,0);
		//tmp_s = tmp_s./sc./nl.*fi;
		fi=fi+1;
	}
	// Lower
	fi=0;
	//fr1 = [fc-bfs/2:-(bff-bfs)/2/nl:fc-bff/2];
	//fr2 = [fc-bff/2:(bff-bfs)/2/nl:fc-bfs/2];
	fprintf(file_pri,"Adding to noise bandpass: lower\n");
	for(float f = fc-bfs/2; f>fc-bff/2; f+= -(bff-bfs)/2.0/nl)
	{
		float amp = 1.0/sc/nl*fi;
		dsp_addcoswave(target,len,sr,f,amp*ampmul,0);
		//tmp_s = tmp_s./sc./nl.*fi;
		fi=fi+1;
	}
}
// Hard-coded test signal of fsk_gentestsignal2
void fsk_gentestsignal2b(signed short *target)
{
	for(int i=0;i<FSKTESTSIGNALLEN;i++)
		target[i] = testsignal_recognizablespectrum[i];
}
void fsk_gentestsignal3(signed short *target)
{
	for(int i=0;i<FSKTESTSIGNALLEN;i++)
		target[i] = testsignal_realundersampled_0[i];
}





/******************************************************************************
	function: fsk_demodout_to_decodein
*******************************************************************************
	Convert the crossproduct output to a binary stream for decoding.

******************************************************************************/
#if 0
void fsk_demodout_to_decodein()
{
	for(unsigned i=0;i<CICBUFSIZ/2;i++)
	{
		_fsk_binary[i] = (_fsk_cp[i]>0)?1:0;
	}
}
#endif




/*
 Real data demodulation + deocding functional test
*/
void dsp_fsk_demod_decode_test_1()
{

	int sr = 1198080;
	int fc = 299520;
	int br=115200;
	int f0 = fc-br/2;
	int f1 = fc+br/2;


	signed short data[FSKTESTSIGNALLEN];			// Same length as matlab
	unsigned datalen=sizeof(data)/sizeof(unsigned short);

	fprintf(file_pri,"Alignment data: %p (%d)\n",data,((unsigned)data)&3);
	fprintf(file_pri,"Alignment _fsk_di: %p (%d)\n",_fsk_di,((unsigned)_fsk_di)&3);
	fprintf(file_pri,"Alignment _fsk_dq: %p (%d)\n",_fsk_dq,((unsigned)_fsk_dq)&3);
	fprintf(file_pri,"Alignment _fsk_dis: %p (%d)\n",_fsk_dis,((unsigned)_fsk_dis)&3);
	fprintf(file_pri,"Alignment _fsk_dqs: %p (%d)\n",_fsk_dqs,((unsigned)_fsk_dqs)&3);
	fprintf(file_pri,"Alignment _fsk_binary: %p (%d)\n",_fsk_binary,((unsigned)_fsk_binary)&3);



	fprintf(file_pri,"Test data lenghth: %d\n",datalen);

	// Real recorded signal
	fsk_gentestsignal3(data);
	fprintf(file_pri,"Data: "); print_array_short(file_pri,data,datalen);

	// Step-by-step demodulation.
	// Number of frames
	int nf = FSKTESTSIGNALLEN/CICBUFSIZ;

	/*unsigned log=0;
	FILE *file = ufat_log_open(log);
	if(!file)
	{
		fprintf(file_pri,"Error opening log %d\n",log);
		return 1;
	}*/

	fsk_demod_init();									// Initialise demodulation
	FILE *ffsk = comm_softuart_open(sr/2,br);			// sr/2 as demod downsamples


	for(int fi=0;fi<nf;fi++)
	//for(int fi=0;fi<1;fi++)
	{
		fprintf(file_pri,"Processing frame %d out of %d\n",fi,nf);
		//fprintf(file_pri,"Data: "); print_array_short(file_pri,&data[fi*CICBUFSIZ],CICBUFSIZ);
		// Initialise the internal buffers for easy debugging
		/*for(unsigned i=0;i<CICBUFSIZ/2;i++)
		{
			_fsk_di[i+1]=_fsk_dq[i+1]=0xfffff;		// +1 as di,dq has +1 size
			_fsk_cp[i]=0xfffff;
		}*/
		//CICBUFSIZ

		// Demodulate: input is data, output is in the crossproduct buffer
		unsigned long t1 = timer_us_get();
		//fsk_demod_frame(&data[fi*CICBUFSIZ],_fsk_binary,2);		// Use all the input signal
		fsk_demod_frame(data,_fsk_binary,2);		// Use only first frame of signal
		// Binarise cp and move to binary signal buffer
		unsigned long t2 = timer_us_get();
		//fsk_demodout_to_decodein();
		// Decode binary signal buffer
		unsigned long t3 = timer_us_get();
		unsigned nd = comm_softuart_decode_frame(_fsk_binary,CICBUFSIZ/2);
		unsigned long t4 = timer_us_get();

		fprintf(file_pri,"Decoded %d bytes. Demodulate: %u us. Copy: %u us. Decode: %u us\n",nd,t2-t1,t3-t2,t4-t3);

		// Print received bytes
		int c; fprintf(file_pri,"Data:\n"); while((c=fgetc(ffsk))!=-1) fprintf(file_pri,"%02X ",c); fprintf(file_pri,"\n");


		/*fprintf(file_pri,"I:\n"); for(unsigned i=0;i<CICBUFSIZ/2;i++) fprintf(file_pri,"%d ",_fsk_di[i+1]>>8); fprintf(file_pri,"\n");
		fprintf(file_pri,"Q:\n"); for(unsigned i=0;i<CICBUFSIZ/2;i++) fprintf(file_pri,"%d ",_fsk_dq[i+1]>>8); fprintf(file_pri,"\n");
		fprintf(file_pri,"CP:\n"); for(unsigned i=0;i<CICBUFSIZ/2;i++) fprintf(file_pri,"%d ",_fsk_cp[i]); fprintf(file_pri,"\n");*/

		/*fprintf(file,"I:\n"); for(unsigned i=0;i<CICBUFSIZ/2;i++) fprintf(file,"%d ",_fsk_di[i+1]>>8); fprintf(file,"\n");
		fprintf(file,"Q:\n"); for(unsigned i=0;i<CICBUFSIZ/2;i++) fprintf(file,"%d ",_fsk_dq[i+1]>>8); fprintf(file,"\n");
		fprintf(file,"CP:\n"); for(unsigned i=0;i<CICBUFSIZ/2;i++) fprintf(file,"%d ",_fsk_cp[i]); fprintf(file,"\n");*/


	}
	//ufat_log_close();

	// Print decoded bytes


}
/*
 Real data demodulation + deocding benchmark
*/
void dsp_fsk_demod_decode_test_2()
{

	int sr = 1198080;
	int fc = 299520;
	int br=115200;
	int f0 = fc-br/2;
	int f1 = fc+br/2;


	signed short data[FSKTESTSIGNALLEN];			// Same length as matlab
	unsigned datalen=sizeof(data)/sizeof(unsigned short);


	fprintf(file_pri,"Test data lenghth: %d\n",datalen);

	// Real recorded signal
	fsk_gentestsignal3(data);
	//fprintf(file_pri,"Data: "); print_array_short(file_pri,data,datalen);

	// Step-by-step demodulation.
	// Number of frames
	int nf = FSKTESTSIGNALLEN/CICBUFSIZ;

	/*unsigned log=0;
	FILE *file = ufat_log_open(log);
	if(!file)
	{
		fprintf(file_pri,"Error opening log %d\n",log);
		return 1;
	}*/

	fsk_demod_init();									// Initialise demodulation
	FILE *ffsk = comm_softuart_open(sr/2,br);			// sr/2 as demod downsamples


	unsigned t_last=timer_s_wait(),t_cur;
	unsigned tint1=timer_ms_get_intclk();
	unsigned nsample=0;
	unsigned mintime=1;
	unsigned nd=0;
	unsigned tdemod=0;
	while((t_cur=timer_s_get())-t_last<mintime)
	{
		// Demodulate always same frame
		tdemod+=fsk_demod_frame(data,_fsk_binary,0);
		// Binarise cp and move to binary signal buffer
		//fsk_demodout_to_decodein();		// Already done by demod_frame
		// Decode binary signal buffer
		nd += comm_softuart_decode_frame(_fsk_binary,CICBUFSIZ/2);
		// Empty data
		while(fgetc(ffsk)!=-1);

		nsample++;
		//break;	// do once only
	}
	unsigned tint2=timer_ms_get_intclk();
	fprintf(file_pri,"Time: %ds (%lu intclk ms) Frames: %lu. Frames/sec: %lu\n",t_cur-t_last,tint2-tint1,nsample,nsample/(t_cur-t_last));
	fprintf(file_pri,"Decoded total of %u bytes in %u frames\n",nd,nsample);
	fprintf(file_pri,"Demod time: %u\n",tdemod);


}

void dsp_fsk_adc_demod_decode_help()
{
	fprintf(file_pri,"Commands:\n");
	fprintf(file_pri,"\t?   : help\n");
	fprintf(file_pri,"\tQ, q: quit\n");
	fprintf(file_pri,"\tR, r: display RX data\n");
	fprintf(file_pri,"\tH, h: toggle hex/ascii RX display\n");
	fprintf(file_pri,"\tA, a: display ADC and demodulated data\n");
	fprintf(file_pri,"\tS, s: display ADC statistics\n");
	fprintf(file_pri,"\tI, i: display processing information at regular intervals\n");
	fprintf(file_pri,"\tW, w: display waveform\n");
	fprintf(file_pri,"\tO, o: overlay waveform display\n");
	fprintf(file_pri,"\tK, k: generate reference 200Hz tone with sr=8KHz\n");
	fprintf(file_pri,"\tP, p: play received data an 8-bit audio stream (default sr=8KHz)\n");
	fprintf(file_pri,"\t8: set sr=8KHz\n");
	fprintf(file_pri,"\t0: set sr=10KHz\n");
	fprintf(file_pri,"\tK, k: generate reference 200Hz tone with sr=8KHz\n");
	fprintf(file_pri,"\t*, /: increase/decrease sample rate. Needs to stop/start audio to take effect\n");
	fprintf(file_pri,"\tx: Enable checksum check using bit 0\n");
}
void dsp_fsk_adc_demod_decode_printstat(signed short *adcdata,unsigned len)
{
	int mean = dsp_mean(adcdata,len);
	int std = dsp_std(adcdata,len,mean);
	int mn = dsp_min(adcdata,len);
	int mx = dsp_max(adcdata,len);
	fprintf(file_pri,"Mean: %d. Standard deviation: %d. Min: %d. Max: %d\n",mean,std,mn,mx);
	// Calculate a histogram. ADC data is in range 0-4095. Assume bins of 64, i.e. 64*64=4096.
	unsigned long hist[64];
	hist_init(hist,64);
	for(int i=0;i<len;i++)
	{
		hist_insert(hist,64,64,adcdata[i]);
	}
	// Print histogram
	hist_print(file_pri,hist,64,64);
}
unsigned ckparity(unsigned char b)
{
	// Parity should be even, i.e. even number of ones.
	unsigned char p=0;
	// popcount
	for(unsigned i=0;i<8;i++)
	{
		p+=b&1;
		b>>=1;
	}
	// Return 0 if parity is even (i.e. correct parity).
	return p&1;
}

unsigned dsp_fsk_adc_demod_decode_loop_audioplayback_enabled=0;
unsigned dispadc=0;
unsigned dispinfo=0;
unsigned disprx=0;
unsigned disphex=0;
unsigned dispstat=0;
unsigned dispwave=0;
unsigned dispoverlay=0;
unsigned opt_cksum=0;
void dsp_fsk_adc_demod_decode_loop_audioplayback(unsigned short * restrict buffer,unsigned int n)
{
	char data[DACDMAHALFBUFSIZ];		// n is equal to DACDMAHALFBUFSIZ.



	if(dsp_fsk_adc_demod_decode_loop_audioplayback_enabled==0)
	{
		for(unsigned i=0;i<n;i++)
			buffer[i]=0;
		return;
	}

#if 0
	for(unsigned i=0;i<n;i++)
	{
		buffer[i] = 0;
		for(int w=0;w<_stm_dac_cosinegenerator_numwaveforms;w++)
		{
			unsigned int s = _stm_dac_cos_lut[_stm_dac_lut_index[w]>>16];		// Index is in 16.16 format
			s=(s*_stm_dac_waveform_vol[w])>>12;									// Volume is 0..4096 inclusive
			buffer[i] += s;
			_stm_dac_lut_index[w] += _stm_dac_lut_incr[w];
			_stm_dac_lut_index[w] &= STMDAC_LUTINDEXMASK;						// Wraparound
		}
		//_stm_dac_dmabuf[DACDMAHALFBUFSIZ+i] /= _stm_dac_numwaveforms;			// Rescale to ensure same amplitude regardless of number of waveforms
		//_stm_dac_dmabuf[DACDMAHALFBUFSIZ+i] /= _stm_dac_ampldiv;
	}
	return;
#endif

	// Playback is enabled: should read data

	//unsigned rd = fread(data,1,DACDMAHALFBUFSIZ,_serial_uasrt3_file);	// Can't use fread in interrupt as blocking
	unsigned tt1,tt2,tt3;
	tt1=timer_us_get();
	unsigned rd=0;

	if(comm_softuart_level()<DACDMAHALFBUFSIZ)
	{
		fprintf(file_pri,"Not enough - skip frame\n");
		for(unsigned i=0;i<n;i++)
		{
			buffer[i]=0;
		}
		return;
	}
	rd = comm_softuart_get(data,DACDMAHALFBUFSIZ);

	if(rd!=DACDMAHALFBUFSIZ)
	{
		fprintf(file_pri,"Not enough data! n: %d rd: %d\n",n,rd);

	}
	// Calculate checksum
	if(opt_cksum)
	{
		for(unsigned i=0;i<n;i++)
		{
			if(ckparity(data[i]))
				fprintf(file_pri,"Parity error at %u: %02X\n",i,data[i]);
		}
	}

	// Generate triangle
	for(unsigned i=0;i<n;i++)
	{
		//buffer[i] = i;
		buffer[i] = data[i];
	}
	tt2=timer_us_get();
	fprintf(file_pri,"Dac: %u\n",tt2-tt1);
	//tt3=timer_us_get();
	//fprintf(file_pri,"DAC cb: %u bytes. %u %u\n",rd, tt2-tt1,tt3-tt2);
}
dsp_fsk_adc_demod_decode_loop_play_triangle(unsigned short * restrict buffer,unsigned int n)
{
	for(unsigned i=0;i<n;i++)
	{	// Triangle wave
		buffer[i] = (i&31)*8;
	}
}
/******************************************************************************
	function: dsp_fsk_adc_demod_decode_loop
*******************************************************************************
	Continuously acquire ADC data, demodulate, decode and print.

	Input:
		sr:		ADC sample rate
		br:		Data bitrate

******************************************************************************/
void dsp_fsk_adc_demod_decode_loop(unsigned sr,unsigned br,unsigned autoplay)
{
	signed short adcdata[ADCFAST_BUFFERSIZE];
	char rxbytes[ADCFAST_BUFFERSIZE];

	//br/=10;
	//br/=5;
	//br*=2;
	//br = 192000;
	//br=115000;

	fprintf(file_pri,"Continuous decoding until key press\n");
	fprintf(file_pri,"Desired sample rate: %d. Bit rate: %u\n",sr,br);

	dsp_fsk_adc_demod_decode_help();


	// Initialise the ADC
	unsigned prescaler=0;
	//unsigned channels = 0b10000;
	unsigned channels = 0b00001;	// Channel 1
	// Calculate divider
	unsigned divider = stm_adcfast_samplerate_to_divider(sr,prescaler);

	// Stop any previous acquisition
	stm_adcfast_acquire_stop();

	// Initialise demodulation
	fsk_demod_init();
	// Initialise decoding. sr/2 as demod downsamples
	FILE *ffsk = comm_softuart_open(sr/2,br);
	//FILE *ffsk = comm_softuart_open(1198080/2,br);




	int c;
	unsigned tdm0=0,tdm1=0,tdm2=0,tdm3=0;
	unsigned adc_effsize;
	unsigned long adc_timems,adc_pktctr;
	unsigned nsample=0;
	unsigned stat_nsample=0;
	unsigned stat_decoded=0,tot_decoded=0;
	unsigned nd=0;
	unsigned tdemod=0;
	unsigned statevery=2;
	unsigned t_laststat,t_last,t_cur;
	FILE *file_fsk=0;

	t_laststat=t_last=timer_s_wait();		// Wait to start on integer second
	unsigned tint1=timer_ms_get_intclk();

	// Initialise DAC
	stmdac_init(8000,0); stmdac_deinit();	// Initialise and deinitalise to set the sample rate.
	stm_dac_cosinegenerator_init();
	stm_dac_cosinegenerator_addwaveform(200,256);
	unsigned audio_sr = 8000;

	// Acquire ADC
	stm_adcfast_acquire_start(channels,0,0,0,prescaler,divider);
	int kbd;
	while(1)		// Loop until keypress
	{
		kbd = fgetc(file_pri);
		if(kbd=='R' || kbd=='r')
			disprx=1-disprx;
		if(kbd=='A' || kbd=='a')
			dispadc=1-dispadc;
		if(kbd=='H' || kbd=='h')
			disphex=1-disphex;
		if(kbd=='Q' || kbd=='q')
			break;
		if(kbd=='S' || kbd=='s')
			dispstat=1-dispstat;
		if(kbd=='I' || kbd=='i')
			dispinfo=1-dispinfo;
		if(kbd=='W' || kbd=='w')
			dispwave=1-dispwave;
		if(kbd=='O' || kbd=='o')
			dispoverlay=1-dispoverlay;
		if(kbd=='x')
		{
			opt_cksum=1-opt_cksum;
			fprintf(file_pri,"Parity check: %d\n",opt_cksum);
		}

		if(kbd=='*')
		{
			audio_sr+=100;
			fprintf(file_pri,"New sample rate: %d\n",audio_sr);
		}
		if(kbd=='/')
		{
			audio_sr-=100;
			fprintf(file_pri,"New sample rate: %d\n",audio_sr);
		}
		if(kbd=='8')
		{
			audio_sr=8000;
			fprintf(file_pri,"New sample rate: %d\n",audio_sr);
		}
		if(kbd=='0')
		{
			audio_sr=10000;
			fprintf(file_pri,"New sample rate: %d\n",audio_sr);
		}
		if(kbd=='P' || kbd=='p' || autoplay)
		{
			autoplay=0;
			dsp_fsk_adc_demod_decode_loop_audioplayback_enabled=1-dsp_fsk_adc_demod_decode_loop_audioplayback_enabled;
			if(dsp_fsk_adc_demod_decode_loop_audioplayback_enabled)
				//stmdac_init(8000,stm_dac_cosinegenerator_siggen);
				stmdac_init(audio_sr,dsp_fsk_adc_demod_decode_loop_audioplayback);
			else
				stmdac_deinit();
		}
		if(kbd=='K' || kbd=='k')
		{
			dsp_fsk_adc_demod_decode_loop_audioplayback_enabled=1-dsp_fsk_adc_demod_decode_loop_audioplayback_enabled;
			if(dsp_fsk_adc_demod_decode_loop_audioplayback_enabled)
				//stmdac_init(8000,stm_dac_cosinegenerator_siggen);
				stmdac_init(8000,dsp_fsk_adc_demod_decode_loop_play_triangle);
			else
				stmdac_deinit();
		}
		if(kbd=='?')
			dsp_fsk_adc_demod_decode_help();
		if(kbd=='F' || kbd=='f')
		{
			//file_fsk = serial_usart3_init(br,2);
			file_fsk = serial_usart3_init(br,LL_USART_STOPBITS_2);
			fprintf(file_pri,"Opened file: %p\n",file_fsk);
		}
		if(kbd=='t')
		{
			if(file_fsk)
				fprintf(file_fsk,"TEST\n");
		}
		if(kbd=='T')
		{
			if(file_fsk)
			{
				char d[4096];
				for(int i=0;i<4096;i++)
					d[i]='0'+i%10;
				for(int i=4090;i<4096;i++)
					d[i]=0xff;
				fwrite(d,1,4096,file_fsk);
				fflush(file_fsk);
			}
		}

		// === Get the ADC data ===
		tdm0 = timer_us_get();
		if(stm_adcfast_data_getnext(adcdata,&adc_effsize,&adc_timems,&adc_pktctr))
			continue;	// Skip rest of processing if no data

		// Update statistics
		nsample++;
		stat_nsample++;

		// === Demodulate the data ===
		tdm1 = timer_us_get();
		fsk_demod_frame(adcdata,_fsk_binary,0);
		//fsk_demod_frame(testsignal_realundersampled_0,_fsk_binary,0);
		tdm2 = timer_us_get();

		// === Decode data to binary signal buffer ===
		nd = comm_softuart_decode_frame(_fsk_binary,ADCFAST_BUFFERSIZE/2);
		tdm3 = timer_us_get();

		tot_decoded += nd;		// Number of decoded bytes total.
		stat_decoded += nd;		// Number of decoded bytes for stats.

		// Clear the adcdata for debugging
		//for(unsigned i=0;i<ADCFAST_BUFFERSIZE;i++) adcdata[i]=0;
		// Set adcdata to known value for debugging
		//for(unsigned i=0;i<ADCFAST_BUFFERSIZE;i++) adcdata[i]=testsignal_realundersampled_0[i];


		// === Read the decoded data ===
		// Data read only when audio playback is disabled. Audio playback reads directly from incoming buffer in DAC interrupt for speed.
		if(dsp_fsk_adc_demod_decode_loop_audioplayback_enabled==0)
		{
			unsigned rbi=0;
			// Get the data
			while((c=fgetc(ffsk))!=-1)
			{
				rxbytes[rbi++] = c;

			}
			if(opt_cksum)
			{
				// Always check the received checksum, even if not displayig received data
				for(unsigned i=0;i<rbi;i++)
				{
					if(ckparity(rxbytes[i]))
					{
						fprintf(file_pri,"Parity error at %u: %02x\n",i,rxbytes[i]);
					}
				}
			}

			//fprintf(file_pri,"Decoded: %d\n",nd);
			if(disprx && rbi)
			{

				fprintf(file_pri,"RX: ");

				for(unsigned i=0;i<rbi;i++)
				{
					if(disphex)
					{
						fprintf(file_pri,"%02X ",rxbytes[i]);
					}
					else
					{
						if(rxbytes[i]>=32 && rxbytes[i]<=126)
							fprintf(file_pri," %c ",rxbytes[i]);
						else
							fprintf(file_pri,"%02X ",rxbytes[i]);
					}
				}
				fprintf(file_pri,"\n");
			}
		}

		// === Information ===
		t_cur = timer_s_get();
		// Stat severy statevery milliseconds.
		if(dispinfo && (t_cur-t_laststat>=statevery) )
		{
			fprintf(file_pri,"\n=== Information ===\n");
			fprintf(file_pri,"Elapsed time from start: %u. Total ADC frames: %u. Total bytes decoded: %u\n",t_cur-t_last,nsample,tot_decoded);
			fprintf(file_pri,"ADC buffer level: %u. ADC frames lost: %u\n",stm_adcfast_data_level(),stm_adcfast_stat_lostframes());
			fprintf(file_pri,"Instantaneous ADC frames/s: %u. Sample rate: %u\n",stat_nsample/(t_cur-t_laststat),stat_nsample*ADCFAST_BUFFERSIZE/(t_cur-t_laststat));
			fprintf(file_pri,"Instantaneous RX bytes: %u. Bytes/s: %u\n",stat_decoded,stat_decoded/(t_cur-t_laststat));
			fprintf(file_pri,"Last frame: acquire time: %u us, demodulation time: %u us, decoding time: %u us\n",tdm1-tdm0,tdm2-tdm1,tdm3-tdm2);
			fprintf(file_pri,"UART RX level: %u\n",comm_softuart_level());
			comm_softuart_printstat();
			fprintf(file_pri,"\n");



			// Reset stats for next round
			t_laststat=t_cur;
			stat_nsample=0;
			stat_decoded=0;
		}

		// Calculate statistics / histogram
		if(dispstat && (nsample&1023)==0)
		{
			dsp_fsk_adc_demod_decode_printstat(adcdata,ADCFAST_BUFFERSIZE);
		}


		// Every lots of frames 1024 frame print it
		if(dispadc && (nsample&1023)==0)
		{
			fprintf(file_pri,"ADC:\n");
			print_array_short(file_pri,adcdata,ADCFAST_BUFFERSIZE);
		}

		//continue;

		if(dispadc && (nsample&1023)==0)
		{
			fprintf(file_pri,"Binary:\n");
			print_array_char(file_pri,_fsk_binary,ADCFAST_BUFFERSIZE/2);
		}
		if(dispwave && (nsample&1023)==0)
		{
			scope_plot(file_pri,adcdata,64,32,4095,dispoverlay);
		}



	}
	t_cur=timer_s_get();
	unsigned tint2=timer_ms_get_intclk();
	fprintf(file_pri,"Time: %ds (%lu intclk ms) Frames: %lu. Frames/sec: %lu\n",t_cur-t_last,tint2-tint1,nsample,nsample*1000/(tint2-tint1));
	fprintf(file_pri,"Decoded total of %u bytes in %u frames\n",tot_decoded,nsample);
	fprintf(file_pri,"Sample rate: %u sps\n",nsample*1000*ADCFAST_BUFFERSIZE/(tint2-tint1)/1000);
	//fprintf(file_pri,"Demod time: %u\n",tdemod);

	// Stop playback
	stmdac_deinit();

	// Stop data acquisition
	stm_adcfast_acquire_stop();


}


